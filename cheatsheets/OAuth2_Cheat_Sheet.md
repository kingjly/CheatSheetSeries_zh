# OAuth 2.0 协议安全备忘录

本备忘录描述了基于 RFC 文档的 OAuth 2.0 最佳当前安全实践。OAuth 已成为 API 保护的标准，并成为使用 OpenID Connect 的联合登录基础。OpenID Connect 1.0 是构建在 OAuth 2.0 协议之上的简单身份层。

## 术语

- **访问令牌**：提供抽象，用单一令牌替代不同的授权构造（如用户名和密码、断言），资源服务器可理解此令牌。这种抽象使得可以发出短期有效的访问令牌，并且资源服务器无需理解各种身份验证方案。

- **刷新令牌**：用于获取访问令牌的凭据。由授权服务器颁发给客户端，用于在当前访问令牌失效、过期时获取新的访问令牌，或获取具有相同或更窄范围的额外访问令牌。

- **客户端**：代表资源所有者发出受保护资源请求并获得授权的应用程序。"客户端"一词不暗示任何特定的实现特征。

- **授权服务器（AS）**：成功验证资源所有者身份并获得授权后向客户端颁发访问令牌的服务器。

- **资源所有者（RO）**：能够授予受保护资源访问权限的实体。当资源所有者是人时，称为最终用户。

- **资源服务器（RS）**：托管受保护资源的服务器，能够使用访问令牌接受和响应受保护资源请求。

## OAuth 2.0 基本安全要点

### 基础安全实践

1. 客户端和授权服务器不得暴露可将用户浏览器转发到查询参数中获取的任意 URI 的 URL（"开放重定向器"），这可能导致授权码和访问令牌泄露。

2. 客户端必须确保授权服务器支持 PKCE，并依赖 PKCE 提供的 CSRF 保护。在 OpenID Connect 流程中，"nonce"参数提供 CSRF 保护。否则，必须使用安全绑定到用户代理的一次性用户 CSRF 令牌（携带在"state"参数中）。

3. 当 OAuth 客户端可以与多个授权服务器交互时，客户端应使用颁发者"iss"参数作为对策，或基于授权响应中的"iss"值（如 OpenID 中 ID 令牌中的"iss"声明）。

4. 当与多个授权服务器交互的 OAuth 客户端缺少其他对策选项时，客户端可以使用不同的重定向 URI 来标识授权端点和令牌端点。

5. 授权服务器避免转发或重定向可能意外包含用户凭据的请求。

### PKCE（代码交换证明密钥）机制

PKCE 旨在缓解授权码拦截攻击，最初用于保护原生应用，现已成为广泛部署的 OAuth 特性。

6. 客户端通过使用 PKCE 流程防止授权码注入（重放）。客户端还可以使用 OpenID Connect "nonce"参数。PKCE 挑战或 OpenID Connect "nonce"必须特定于事务，并安全地绑定到启动事务的客户端和用户代理。

7. 使用 PKCE 时，客户端应使用不在授权请求中暴露 PKCE 验证器的代码挑战方法。授权服务器必须支持 PKCE。

8. 如果客户端在授权请求中发送有效的 PKCE "code_challenge" 参数，授权服务器必须在令牌端点强制正确使用 "code_verifier"。

9. 授权服务器通过确保仅在授权请求中存在 "code_challenge" 参数时才接受包含 "code_verifier" 参数的令牌请求，从而缓解 PKCE 降级攻击。

### 隐式授权

10. 客户端使用响应类型 "code"（授权码授权类型）或导致授权服务器在令牌响应中颁发访问令牌的其他响应类型。这允许授权服务器检测攻击者的重放尝试，并减少攻击面，因为访问令牌不会暴露在 URL 中。

### 令牌重放预防

11. 授权和资源服务器使用发送者约束访问令牌的机制，如 OAuth 2.0 的相互 TLS 或 OAuth 拥有证明（DPoP）。

12. 刷新令牌被发送者约束或使用刷新令牌轮换。

### 访问令牌权限限制

13. 访问令牌的权限应限制为特定应用或用例所需的最小权限，防止客户端超出资源所有者授权的权限。

14. 访问令牌限制为特定资源服务器（受众限制），最好限制为单个资源服务器。

15. 访问令牌限制为资源服务器上的特定资源和操作。

### 其他建议

16. 不使用资源所有者密码凭据授权，因为这会不安全地将资源所有者凭据暴露给客户端。

17. 授权服务器尽可能使用客户端身份验证，推荐使用非对称（基于公钥）的身份验证方法。

18. 授权服务器不允许客户端影响其 "client_id" 或 "sub" 值。建议使用端到端 TLS。

19. 授权响应不通过未加密的网络连接传输。授权服务器不得允许使用 "http" 方案的重定向 URI，本地环回接口重定向除外。

## 参考文献

- [RFC 6750](https://www.rfc-editor.org/info/rfc6750)
- [RFC 6749](https://www.rfc-editor.org/info/rfc6749)
- [OAuth 2.0 最佳实践](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#name-best-practices)
