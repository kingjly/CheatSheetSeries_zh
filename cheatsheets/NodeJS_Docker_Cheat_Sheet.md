# Node.js Docker å¤‡å¿˜å½•

ä»¥ä¸‹å¤‡å¿˜å½•æä¾›äº†æ„å»ºä¼˜åŒ–å’Œå®‰å…¨çš„ [Node.js Docker](https://snyk.io/blog/10-best-practices-to-containerize-nodejs-web-applications-with-docker/) çš„ç”Ÿäº§çº§æŒ‡å—ã€‚æ— è®ºæ‚¨è¦æ„å»ºä»€ä¹ˆ Node.js åº”ç”¨ç¨‹åºï¼Œéƒ½ä¼šå‘ç°è¿™å¾ˆæœ‰å¸®åŠ©ã€‚å¦‚æœä»¥ä¸‹æƒ…å†µé€‚ç”¨äºæ‚¨ï¼Œæœ¬æ–‡å°†å¾ˆæœ‰ç”¨ï¼š

- æ‚¨çš„ç›®æ ‡æ˜¯ä½¿ç”¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰çš„ Node.js åŠŸèƒ½æ„å»ºå‰ç«¯åº”ç”¨ç¨‹åºã€‚
- æ‚¨æ­£åœ¨å¯»æ‰¾å¦‚ä½•ä¸ºå¾®æœåŠ¡æ­£ç¡®æ„å»º Node.js Docker é•œåƒçš„å»ºè®®ï¼Œè¿è¡Œ Fastifyã€NestJS æˆ–å…¶ä»–åº”ç”¨ç¨‹åºæ¡†æ¶ã€‚

## 1) ä½¿ç”¨æ˜ç¡®å’Œç¡®å®šæ€§çš„ Docker åŸºç¡€é•œåƒæ ‡ç­¾

ä½¿ç”¨ `node` Docker é•œåƒä½œä¸ºåŸºç¡€é•œåƒå¯èƒ½çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ˜æ˜¾çš„é€‰æ‹©ï¼Œä½†æ˜¯æ‚¨å®é™…ä¸Šåœ¨æ„å»ºé•œåƒæ—¶æ‹‰å–äº†ä»€ä¹ˆï¼ŸDocker é•œåƒæ€»æ˜¯é€šè¿‡æ ‡ç­¾å¼•ç”¨ï¼Œå½“æ‚¨ä¸æŒ‡å®šæ ‡ç­¾æ—¶ï¼Œé»˜è®¤ä½¿ç”¨ `:latest` æ ‡ç­¾ã€‚

ä¾‹å¦‚ï¼Œåœ¨ Dockerfile ä¸­æŒ‡å®šä»¥ä¸‹å†…å®¹æ—¶ï¼Œæ‚¨å§‹ç»ˆæ„å»ºç”± **Node.js Docker å·¥ä½œç»„** æ„å»ºçš„æœ€æ–°ç‰ˆæœ¬ Docker é•œåƒï¼š

### FROM node

åŸºäºé»˜è®¤ `node` é•œåƒæ„å»ºçš„ç¼ºç‚¹å¦‚ä¸‹ï¼š

1. Docker é•œåƒæ„å»ºä¸ä¸€è‡´ã€‚å°±åƒæˆ‘ä»¬ä½¿ç”¨ `lockfiles` æ¥è·å¾—æ¯æ¬¡å®‰è£… npm åŒ…æ—¶ç¡®å®šæ€§çš„ `npm install` è¡Œä¸ºä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›è·å¾—ç¡®å®šæ€§çš„ Docker é•œåƒæ„å»ºã€‚å¦‚æœæˆ‘ä»¬ä» node æ„å»ºé•œåƒï¼ˆå®é™…ä¸Šæ„å‘³ç€ `node:latest` æ ‡ç­¾ï¼‰ï¼Œé‚£ä¹ˆæ¯æ¬¡æ„å»ºéƒ½ä¼šæ‹‰å–æ–°æ„å»ºçš„ Docker é•œåƒã€‚æˆ‘ä»¬ä¸å¸Œæœ›å¼•å…¥è¿™ç§éç¡®å®šæ€§è¡Œä¸ºã€‚

2. Node Docker é•œåƒåŸºäºåŠŸèƒ½é½å…¨çš„æ“ä½œç³»ç»Ÿï¼Œå……æ»¡äº†è¿è¡Œ Node.js Web åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦ä¹Ÿå¯èƒ½ä¸éœ€è¦çš„åº“å’Œå·¥å…·ã€‚è¿™æœ‰ä¸¤ä¸ªç¼ºç‚¹ã€‚é¦–å…ˆï¼Œæ›´å¤§çš„é•œåƒæ„å‘³ç€æ›´å¤§çš„ä¸‹è½½å¤§å°ï¼Œè¿™ä¸ä»…å¢åŠ äº†å­˜å‚¨éœ€æ±‚ï¼Œè¿˜æ„å‘³ç€ä¸‹è½½å’Œé‡æ–°æ„å»ºé•œåƒéœ€è¦æ›´å¤šæ—¶é—´ã€‚å…¶æ¬¡ï¼Œè¿™æ„å‘³ç€æ‚¨å¯èƒ½å¼•å…¥äº†è¿™äº›åº“å’Œå·¥å…·ä¸­å¯èƒ½å­˜åœ¨çš„å®‰å…¨æ¼æ´ã€‚

äº‹å®ä¸Šï¼Œ`node` Docker é•œåƒç›¸å½“å¤§ï¼Œå¹¶åŒ…å«æ•°ç™¾ä¸ªä¸åŒç±»å‹å’Œä¸¥é‡ç¨‹åº¦çš„å®‰å…¨æ¼æ´ã€‚å¦‚æœæ‚¨ä½¿ç”¨å®ƒï¼Œé‚£ä¹ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‚¨çš„èµ·ç‚¹å°†æ˜¯ 642 ä¸ªå®‰å…¨æ¼æ´çš„åŸºçº¿ï¼Œå¹¶ä¸”æ¯æ¬¡æ‹‰å–å’Œæ„å»ºéƒ½ä¼šä¸‹è½½æ•°ç™¾å…†å­—èŠ‚çš„é•œåƒæ•°æ®ã€‚

æ„å»ºæ›´å¥½çš„ Docker é•œåƒçš„å»ºè®®æ˜¯ï¼š

1. ä½¿ç”¨å°å‹ Docker é•œåƒ - è¿™å°†è½¬åŒ–ä¸º Docker é•œåƒä¸Šæ›´å°çš„è½¯ä»¶å ç”¨ç©ºé—´ï¼Œå‡å°‘æ½œåœ¨çš„æ¼æ´å‘é‡ï¼Œå¹¶ä¸”ä½“ç§¯æ›´å°ï¼Œè¿™å°†åŠ å¿«é•œåƒæ„å»ºè¿‡ç¨‹ã€‚
2. ä½¿ç”¨ Docker é•œåƒæ‘˜è¦ï¼Œå³é•œåƒçš„é™æ€ SHA256 å“ˆå¸Œã€‚è¿™ç¡®ä¿ä»åŸºç¡€é•œåƒè·å¾—ç¡®å®šæ€§çš„ Docker é•œåƒæ„å»ºã€‚

åŸºäºæ­¤ï¼Œè®©æˆ‘ä»¬ç¡®ä¿ä½¿ç”¨ Node.js çš„é•¿æœŸæ”¯æŒï¼ˆLTSï¼‰ç‰ˆæœ¬ï¼Œå¹¶ä½¿ç”¨æœ€å°çš„ `alpine` é•œåƒç±»å‹ï¼Œä»¥åœ¨é•œåƒä¸Šæ‹¥æœ‰æœ€å°çš„å¤§å°å’Œè½¯ä»¶å ç”¨ç©ºé—´ï¼š

### FROM node:lts-alpine

å°½ç®¡å¦‚æ­¤ï¼Œè¿™ä¸ªåŸºç¡€é•œåƒæŒ‡ä»¤ä»å°†æ‹‰å–è¯¥æ ‡ç­¾çš„æ–°æ„å»ºã€‚æˆ‘ä»¬å¯ä»¥åœ¨ [Docker Hub ä¸Šä¸ºæ­¤ Node.js æ ‡ç­¾](https://hub.docker.com/layers/node/library/node/lts-alpine/images/sha256-51e341881c2b77e52778921c685e711a186a71b8c6f62ff2edfc6b6950225a2f?context=explore)æ‰¾åˆ°å…¶ `SHA256` å“ˆå¸Œï¼Œæˆ–è€…åœ¨æœ¬åœ°æ‹‰å–æ­¤é•œåƒåè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¹¶åœ¨è¾“å‡ºä¸­å®šä½ `Digest` å­—æ®µï¼š

    $ docker pull node:lts-alpine
    lts-alpine: Pulling from library/node
    0a6724ff3fcd: Already exists
    9383f33fa9f3: Already exists
    b6ae88d676fe: Already exists
    565e01e00588: Already exists
    Digest: sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    Status: Downloaded newer image for node:lts-alpine
    docker.io/library/node:lts-alpine

å¦ä¸€ç§æŸ¥æ‰¾ `SHA256` å“ˆå¸Œçš„æ–¹æ³•æ˜¯è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    $ docker images --digests
    REPOSITORY                     TAG              DIGEST                                                                    IMAGE ID       CREATED             SIZE
    node                           lts-alpine       sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a   51d926a5599d   2 weeks ago         116MB

ç°åœ¨æˆ‘ä»¬å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼æ›´æ–° Node.js Docker é•œåƒçš„ Dockerfileï¼š

    FROM node@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    WORKDIR /usr/src/app
    COPY . /usr/src/app
    RUN npm install
    CMD "npm" "start"

ç„¶è€Œï¼Œä¸Šé¢çš„ Dockerfile ä»…æŒ‡å®šäº† Node.js Docker é•œåƒåç§°ï¼Œæ²¡æœ‰é•œåƒæ ‡ç­¾ï¼Œè¿™ä¼šé€ æˆä½¿ç”¨å“ªä¸ªç¡®åˆ‡é•œåƒæ ‡ç­¾çš„æ­§ä¹‰ - è¿™ä¸å¯è¯»ï¼Œéš¾ä»¥ç»´æŠ¤ï¼Œå¹¶ä¸”ä¸èƒ½åˆ›å»ºè‰¯å¥½çš„å¼€å‘è€…ä½“éªŒã€‚

è®©æˆ‘ä»¬é€šè¿‡æ›´æ–° Dockerfile æ¥ä¿®å¤å®ƒï¼Œä¸ºå¯¹åº”è¯¥ `SHA256` å“ˆå¸Œçš„ Node.js ç‰ˆæœ¬æä¾›å®Œæ•´çš„åŸºç¡€é•œåƒæ ‡ç­¾ï¼š

    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    WORKDIR /usr/src/app
    COPY . /usr/src/app
    RUN npm install
    CMD "npm" "start"

## 2) ä»…åœ¨ Node.js Docker é•œåƒä¸­å®‰è£…ç”Ÿäº§ä¾èµ–

ä»¥ä¸‹ Dockerfile æŒ‡ä»¤åœ¨å®¹å™¨ä¸­å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ŒåŒ…æ‹¬ `devDependencies`ï¼Œè¿™å¯¹äºåŠŸèƒ½æ€§åº”ç”¨ç¨‹åºçš„è¿è¡Œæ˜¯ä¸éœ€è¦çš„ã€‚å®ƒå¢åŠ äº†æ¥è‡ªå¼€å‘ä¾èµ–åŒ…çš„ä¸å¿…è¦çš„å®‰å…¨é£é™©ï¼Œå¹¶ä¸”ä¸å¿…è¦åœ°è†¨èƒ€äº†é•œåƒå¤§å°ã€‚

**`RUN npm install`**

ä½¿ç”¨ `npm ci` å¼ºåˆ¶æ‰§è¡Œç¡®å®šæ€§æ„å»ºã€‚è¿™å¯ä»¥é˜²æ­¢æŒç»­é›†æˆï¼ˆCIï¼‰æµç¨‹ä¸­çš„æ„å¤–ï¼Œå› ä¸ºå¦‚æœä¸é”æ–‡ä»¶æœ‰ä»»ä½•åå·®ï¼Œå®ƒéƒ½ä¼šåœæ­¢ã€‚

åœ¨æ„å»ºç”Ÿäº§ç¯å¢ƒçš„ Docker é•œåƒæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ç¡®ä¿ä»¥ç¡®å®šæ€§çš„æ–¹å¼ä»…å®‰è£…ç”Ÿäº§ä¾èµ–ï¼Œè¿™ä¸ºæˆ‘ä»¬å¸¦æ¥äº†åœ¨å®¹å™¨é•œåƒä¸­å®‰è£… npm ä¾èµ–çš„æœ€ä½³å®è·µå»ºè®®ï¼š

**`RUN npm ci --omit=dev`**

æ­¤é˜¶æ®µæ›´æ–°åçš„ Dockerfile å†…å®¹å¦‚ä¸‹ï¼š

    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    WORKDIR /usr/src/app
    COPY . /usr/src/app
    RUN npm ci --omit=dev
    CMD "npm" "start"

## 3) ä¸ºç”Ÿäº§ç¯å¢ƒä¼˜åŒ– Node.js å·¥å…·

åœ¨ä¸ºç”Ÿäº§ç¯å¢ƒæ„å»º Node.js Docker é•œåƒæ—¶ï¼Œæ‚¨å¸Œæœ›ç¡®ä¿æ‰€æœ‰æ¡†æ¶å’Œåº“éƒ½ä½¿ç”¨æ€§èƒ½å’Œå®‰å…¨æ€§çš„æœ€ä½³è®¾ç½®ã€‚

è¿™ä¿ƒä½¿æˆ‘ä»¬æ·»åŠ ä»¥ä¸‹ Dockerfile æŒ‡ä»¤ï¼š

**`ENV NODE_ENV production`**

ä¹çœ‹ä¹‹ä¸‹ï¼Œè¿™çœ‹èµ·æ¥æ˜¯å¤šä½™çš„ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»åœ¨ `npm install` é˜¶æ®µä»…æŒ‡å®šäº†ç”Ÿäº§ä¾èµ– - é‚£ä¸ºä»€ä¹ˆè¿™æ˜¯å¿…è¦çš„ï¼Ÿ

å¼€å‘è€…ä¸»è¦å°† `NODE_ENV=production` ç¯å¢ƒå˜é‡è®¾ç½®ä¸å®‰è£…ç”Ÿäº§ç›¸å…³ä¾èµ–å…³è”ï¼Œç„¶è€Œï¼Œè¿™ä¸ªè®¾ç½®è¿˜æœ‰å…¶ä»–å½±å“éœ€è¦æˆ‘ä»¬æ³¨æ„ã€‚

ä¸€äº›æ¡†æ¶å’Œåº“å¯èƒ½åªæœ‰åœ¨ `NODE_ENV` ç¯å¢ƒå˜é‡è®¾ç½®ä¸º `production` æ—¶æ‰ä¼šå¯ç”¨é€‚åˆç”Ÿäº§çš„ä¼˜åŒ–é…ç½®ã€‚æ’‡å¼€æˆ‘ä»¬å¯¹æ¡†æ¶é‡‡ç”¨è¿™ç§åšæ³•çš„çœ‹æ³•ï¼Œäº†è§£è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚

ä¾‹å¦‚ï¼Œ[Express æ–‡æ¡£](https://expressjs.com/en/advanced/best-practice-performance.html#set-node_env-to-production)æ¦‚è¿°äº†è®¾ç½®æ­¤ç¯å¢ƒå˜é‡å¯¹å¯ç”¨æ€§èƒ½å’Œå®‰å…¨ç›¸å…³ä¼˜åŒ–çš„é‡è¦æ€§ã€‚

æ€§èƒ½å½±å“å¯èƒ½éå¸¸æ˜¾è‘—ã€‚

æ‚¨ä¾èµ–çš„è®¸å¤šå…¶ä»–åº“å¯èƒ½ä¹ŸæœŸæœ›è®¾ç½®æ­¤å˜é‡ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥åœ¨ Dockerfile ä¸­è®¾ç½®å®ƒã€‚

ç°åœ¨ï¼ŒDockerfile åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼Œå†…ç½®äº† `NODE_ENV` ç¯å¢ƒå˜é‡è®¾ç½®ï¼š

    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    ENV NODE_ENV production
    WORKDIR /usr/src/app
    COPY . /usr/src/app
    RUN npm ci --omit=dev
    CMD "npm" "start"
    
## 4) ä¸è¦ä»¥ root ç”¨æˆ·è¿è¡Œå®¹å™¨

æœ€å°æƒé™åŸåˆ™æ˜¯ Unix æ—©æœŸçš„ä¸€é¡¹é•¿æœŸå®‰å…¨æ§åˆ¶ï¼Œæˆ‘ä»¬åœ¨è¿è¡Œå®¹å™¨åŒ–çš„ Node.js Web åº”ç”¨ç¨‹åºæ—¶åº”å§‹ç»ˆéµå¾ªè¿™ä¸€åŸåˆ™ã€‚

å¨èƒè¯„ä¼°éå¸¸ç›´æ¥ - å¦‚æœæ”»å‡»è€…èƒ½å¤Ÿä»¥å…è®¸[å‘½ä»¤æ³¨å…¥](https://owasp.org/www-community/attacks/Command_Injection)æˆ–[ç›®å½•è·¯å¾„éå†](https://owasp.org/www-community/attacks/Path_Traversal)çš„æ–¹å¼ç ´å Web åº”ç”¨ç¨‹åºï¼Œè¿™äº›æ“ä½œå°†ä»¥æ‹¥æœ‰åº”ç”¨ç¨‹åºè¿›ç¨‹çš„ç”¨æˆ·èº«ä»½æ‰§è¡Œã€‚å¦‚æœè¯¥è¿›ç¨‹æ°å¥½æ˜¯ rootï¼Œé‚£ä¹ˆä»–ä»¬å‡ ä¹å¯ä»¥åœ¨å®¹å™¨å†…æ‰§è¡Œä»»ä½•æ“ä½œï¼ŒåŒ…æ‹¬[å°è¯•å®¹å™¨é€ƒé€¸](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/03-Testing_for_Privilege_Escalation)ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å†’è¿™ä¸ªé™©ï¼Ÿæ²¡é”™ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ã€‚

è¯·è®°ä½ï¼š**"æœ‹å‹ä¸ä¼šè®©æœ‹å‹ä»¥ root ç”¨æˆ·è¿è¡Œå®¹å™¨ï¼"**

å®˜æ–¹çš„ `node` Docker é•œåƒåŠå…¶å˜ä½“ï¼ˆå¦‚ `alpine`ï¼‰åŒ…å«ä¸€ä¸ªåŒåçš„æœ€å°æƒé™ç”¨æˆ·ï¼š`node`ã€‚ç„¶è€Œï¼Œä»…ä»…ä»¥ `node` ç”¨æˆ·è¿è¡Œè¿›ç¨‹æ˜¯ä¸å¤Ÿçš„ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹æ–¹å¼å¯èƒ½ä¸é€‚åˆåº”ç”¨ç¨‹åºæ­£å¸¸è¿è¡Œï¼š

    USER node
    CMD "npm" "start"

åŸå› æ˜¯ Dockerfile çš„ `USER` æŒ‡ä»¤åªç¡®ä¿è¿›ç¨‹ç”± `node` ç”¨æˆ·æ‹¥æœ‰ã€‚ä½†æ˜¯æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ `COPY` æŒ‡ä»¤å¤åˆ¶çš„æ‰€æœ‰æ–‡ä»¶å‘¢ï¼Ÿå®ƒä»¬æ˜¯ç”± root æ‹¥æœ‰çš„ã€‚è¿™æ˜¯ Docker çš„é»˜è®¤è¡Œä¸ºã€‚

å®Œæ•´ä¸”æ­£ç¡®çš„é™ä½æƒé™çš„æ–¹æ³•å¦‚ä¸‹ï¼ŒåŒæ—¶å±•ç¤ºäº†æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢çš„ Dockerfile æœ€ä½³å®è·µï¼š

    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    ENV NODE_ENV production
    WORKDIR /usr/src/app
    COPY --chown=node:node . /usr/src/app
    RUN npm ci --omit=dev
    USER node
    CMD "npm" "start"

## 5) æ­£ç¡®å¤„ç†äº‹ä»¶ä»¥å®‰å…¨åœ°ç»ˆæ­¢ Node.js Docker Web åº”ç”¨ç¨‹åº

åœ¨å…³äºå®¹å™¨åŒ– Node.js åº”ç”¨ç¨‹åºçš„åšå®¢å’Œæ–‡ç« ä¸­ï¼Œæˆ‘ç»å¸¸çœ‹åˆ°ä¸€ä¸ªæœ€å¸¸è§çš„é”™è¯¯æ˜¯è°ƒç”¨è¿›ç¨‹çš„æ–¹å¼ã€‚ä»¥ä¸‹æ‰€æœ‰æ–¹å¼åŠå…¶å˜ä½“éƒ½æ˜¯åº”è¯¥é¿å…çš„ä¸è‰¯æ¨¡å¼ï¼š

- `CMD "npm" "start"`
- `CMD ["yarn", "start"]`
- `CMD "node" "server.js"`
- `CMD "start-app.sh"`

è®©æˆ‘ä»¬æ·±å…¥æ¢è®¨ï¼æˆ‘å°†å¸¦æ‚¨äº†è§£å®ƒä»¬çš„åŒºåˆ«ä»¥åŠä¸ºä»€ä¹ˆéƒ½æ˜¯åº”è¯¥é¿å…çš„æ¨¡å¼ã€‚

ç†è§£æ­£ç¡®è¿è¡Œå’Œç»ˆæ­¢ Node.js Docker åº”ç”¨ç¨‹åºçš„å…³é”®ç‚¹å¦‚ä¸‹ï¼š

1. ç¼–æ’å¼•æ“ï¼ˆå¦‚ Docker Swarmã€Kubernetes æˆ–ä»…ä»…æ˜¯ Docker å¼•æ“æœ¬èº«ï¼‰éœ€è¦ä¸€ç§å‘å®¹å™¨ä¸­çš„è¿›ç¨‹å‘é€ä¿¡å·çš„æ–¹æ³•ã€‚ä¸»è¦æ˜¯ç»ˆæ­¢åº”ç”¨ç¨‹åºçš„ä¿¡å·ï¼Œå¦‚ `SIGTERM` å’Œ `SIGKILL`ã€‚
2. è¿›ç¨‹å¯èƒ½é—´æ¥è¿è¡Œï¼Œå¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œåˆ™ä¸èƒ½ä¿è¯å®ƒä¼šæ”¶åˆ°è¿™äº›ä¿¡å·ã€‚
3. Linux å†…æ ¸å¯¹ä»¥è¿›ç¨‹ ID 1ï¼ˆPIDï¼‰è¿è¡Œçš„è¿›ç¨‹çš„å¤„ç†æ–¹å¼ä¸å…¶ä»–è¿›ç¨‹ ID ä¸åŒã€‚

æŒæ¡äº†è¿™äº›çŸ¥è¯†ï¼Œè®©æˆ‘ä»¬å¼€å§‹ç ”ç©¶å®¹å™¨è¿›ç¨‹è°ƒç”¨çš„æ–¹å¼ï¼Œä»æˆ‘ä»¬æ­£åœ¨æ„å»ºçš„ Dockerfile ä¸­çš„ç¤ºä¾‹å¼€å§‹ï¼š

**`CMD "npm" "start"`**

è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ç›´æ¥è°ƒç”¨ npm å®¢æˆ·ç«¯é—´æ¥è¿è¡Œ Node åº”ç”¨ç¨‹åºã€‚è°èƒ½ä¿è¯ npm CLI å°†æ‰€æœ‰äº‹ä»¶è½¬å‘åˆ° Node è¿è¡Œæ—¶ï¼Ÿäº‹å®ä¸Šï¼Œå®ƒå¹¶ä¸ä¼šï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æµ‹è¯•è¿™ä¸€ç‚¹ã€‚

ç¡®ä¿åœ¨æ‚¨çš„ Node.js åº”ç”¨ç¨‹åºä¸­è®¾ç½® `SIGHUP` ä¿¡å·çš„äº‹ä»¶å¤„ç†ç¨‹åºï¼Œæ¯æ¬¡å‘é€äº‹ä»¶æ—¶éƒ½è®°å½•åˆ°æ§åˆ¶å°ã€‚ä¸€ä¸ªç®€å•çš„ä»£ç ç¤ºä¾‹åº”å¦‚ä¸‹æ‰€ç¤ºï¼š

    function handle(signal) {
       console.log(`*^!@4=> Received event: ${signal}`)
    }
    process.on('SIGHUP', handle)

ç„¶åè¿è¡Œå®¹å™¨ï¼Œä¸€æ—¦å®ƒå¯åŠ¨ï¼Œä½¿ç”¨ `docker` CLI å’Œç‰¹æ®Šçš„ `--signal` å‘½ä»¤è¡Œæ ‡å¿—ä¸“é—¨å‘å…¶å‘é€ `SIGHUP` ä¿¡å·ï¼š

**`$ docker kill --signal=SIGHUP elastic_archimedes`**

ä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿï¼Œå¯¹å§ï¼Ÿè¿™æ˜¯å› ä¸º npm å®¢æˆ·ç«¯ä¸ä¼šå°†ä»»ä½•ä¿¡å·è½¬å‘åˆ°å®ƒç”Ÿæˆçš„ Node è¿›ç¨‹ã€‚

å¦ä¸€ä¸ªé—®é¢˜ä¸åœ¨ Dockerfile ä¸­æŒ‡å®š `CMD` æŒ‡ä»¤çš„ä¸åŒæ–¹å¼æœ‰å…³ã€‚æœ‰ä¸¤ç§æ–¹å¼ï¼Œå®ƒä»¬å¹¶ä¸ç›¸åŒï¼š

1. shell å½¢å¼è¡¨ç¤ºæ³•ï¼Œå®¹å™¨ç”Ÿæˆä¸€ä¸ªåŒ…è£…è¿›ç¨‹çš„ shell è§£é‡Šå™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œshell å¯èƒ½æ— æ³•æ­£ç¡®åœ°å°†ä¿¡å·è½¬å‘åˆ°æ‚¨çš„è¿›ç¨‹ã€‚
2. exec å½¢å¼è¡¨ç¤ºæ³•ï¼Œç›´æ¥ç”Ÿæˆè¿›ç¨‹è€Œä¸å°†å…¶åŒ…è£…åœ¨ shell ä¸­ã€‚ä½¿ç”¨ JSON æ•°ç»„è¡¨ç¤ºæ³•æŒ‡å®šï¼Œä¾‹å¦‚ï¼š`CMD ["npm", "start"]`ã€‚å‘é€åˆ°å®¹å™¨çš„ä»»ä½•ä¿¡å·éƒ½ç›´æ¥å‘é€åˆ°è¿›ç¨‹ã€‚

åŸºäºè¿™äº›çŸ¥è¯†ï¼Œæˆ‘ä»¬å¸Œæœ›æŒ‰å¦‚ä¸‹æ–¹å¼æ”¹è¿› Dockerfile è¿›ç¨‹æ‰§è¡ŒæŒ‡ä»¤ï¼š

**`CMD ["node", "server.js"]`**

æˆ‘ä»¬ç°åœ¨ç›´æ¥è°ƒç”¨ Node è¿›ç¨‹ï¼Œç¡®ä¿å®ƒæ¥æ”¶å‘é€ç»™å®ƒçš„æ‰€æœ‰ä¿¡å·ï¼Œè€Œä¸æ˜¯è¢« shell è§£é‡Šå™¨åŒ…è£…ã€‚

ç„¶è€Œï¼Œè¿™åˆå¼•å…¥äº†å¦ä¸€ä¸ªé™·é˜±ã€‚

å½“è¿›ç¨‹ä»¥ PID 1 è¿è¡Œæ—¶ï¼Œå®ƒå®é™…ä¸Šæ‰¿æ‹…äº†åˆå§‹åŒ–ç³»ç»Ÿçš„ä¸€äº›èŒè´£ï¼Œè¯¥ç³»ç»Ÿé€šå¸¸è´Ÿè´£åˆå§‹åŒ–æ“ä½œç³»ç»Ÿå’Œè¿›ç¨‹ã€‚å†…æ ¸ä»¥ä¸åŒäºå…¶ä»–è¿›ç¨‹æ ‡è¯†ç¬¦çš„æ–¹å¼å¤„ç† PID 1ã€‚è¿™ç§å†…æ ¸çš„ç‰¹æ®Šå¤„ç†æ„å‘³ç€ï¼Œå¦‚æœè¿›ç¨‹å°šæœªä¸ºå…¶è®¾ç½®å¤„ç†ç¨‹åºï¼Œåˆ™å‘æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å‘é€ `SIGTERM` ä¿¡å·ä¸ä¼šè°ƒç”¨é»˜è®¤çš„ç»ˆæ­¢è¿›ç¨‹è¡Œä¸ºã€‚

å¼•ç”¨ [Node.js Docker å·¥ä½œç»„çš„å»ºè®®](https://github.com/nodejs/docker-node/blob/master/docs/BestPractices.md#handling-kernel-signals)ï¼š"Node.js å¹¶éè®¾è®¡ä¸ºåœ¨ PID 1 ä¸‹è¿è¡Œï¼Œè¿™åœ¨ Docker å†…éƒ¨ä¼šå¯¼è‡´æ„å¤–è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œä½œä¸º PID 1 è¿è¡Œçš„ Node.js è¿›ç¨‹ä¸ä¼šå“åº” SIGINTï¼ˆCTRL-Cï¼‰å’Œç±»ä¼¼ä¿¡å·"ã€‚

å› æ­¤ï¼Œæ­£ç¡®çš„åšæ³•æ˜¯ä½¿ç”¨ä¸€ä¸ªå……å½“åˆå§‹åŒ–è¿›ç¨‹çš„å·¥å…·ï¼Œå®ƒä»¥ PID 1 è°ƒç”¨ï¼Œç„¶åç”Ÿæˆæˆ‘ä»¬çš„ Node.js åº”ç”¨ç¨‹åºä½œä¸ºå¦ä¸€ä¸ªè¿›ç¨‹ï¼ŒåŒæ—¶ç¡®ä¿æ‰€æœ‰ä¿¡å·éƒ½ä»£ç†åˆ°è¯¥ Node.js è¿›ç¨‹ã€‚å¦‚æœå¯èƒ½ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨å°½å¯èƒ½å°çš„å·¥å…·æ¥å®Œæˆæ­¤æ“ä½œï¼Œä»¥é¿å…å‘å®¹å™¨é•œåƒæ·»åŠ å®‰å…¨æ¼æ´ã€‚

[dumb-init](https://engineeringblog.yelp.com/2016/01/dumb-init-an-init-for-docker.html) å°±æ˜¯è¿™æ ·ä¸€ä¸ªå·¥å…·ï¼Œå®ƒæ˜¯é™æ€é“¾æ¥çš„ï¼Œå¹¶ä¸”å ç”¨ç©ºé—´å¾ˆå°ã€‚ä»¥ä¸‹æ˜¯è®¾ç½®æ–¹æ³•ï¼š

    RUN apk add dumb-init
    CMD ["dumb-init", "node", "server.js"]

è¿™ä¸ºæˆ‘ä»¬å¸¦æ¥äº†ä»¥ä¸‹æœ€æ–°çš„ Dockerfileã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å°† `dumb-init` åŒ…å®‰è£…æ”¾åœ¨é•œåƒå£°æ˜ä¹‹åï¼Œä»¥ä¾¿åˆ©ç”¨ Docker çš„å±‚ç¼“å­˜ï¼š

    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    RUN apk add dumb-init
    ENV NODE_ENV production
    WORKDIR /usr/src/app
    COPY --chown=node:node . .
    RUN npm ci --omit=dev
    USER node
    CMD ["dumb-init", "node", "server.js"]

éœ€è¦äº†è§£çš„æ˜¯ï¼š`docker kill` å’Œ `docker stop` å‘½ä»¤åªå‘ PID 1 çš„å®¹å™¨è¿›ç¨‹å‘é€ä¿¡å·ã€‚å¦‚æœæ‚¨è¿è¡Œçš„æ˜¯è¿è¡Œ Node.js åº”ç”¨ç¨‹åºçš„ shell è„šæœ¬ï¼Œè¯·æ³¨æ„ shell å®ä¾‹ï¼ˆå¦‚ `/bin/sh`ï¼‰ä¸ä¼šå°†ä¿¡å·è½¬å‘ç»™å­è¿›ç¨‹ï¼Œè¿™æ„å‘³ç€æ‚¨çš„åº”ç”¨ç¨‹åºæ°¸è¿œä¸ä¼šæ”¶åˆ° `SIGTERM`ã€‚

## 6) ä¸º Node.js Web åº”ç”¨ç¨‹åºæä¾›ä¼˜é›…çš„å…³é—­æœºåˆ¶

æ—¢ç„¶æˆ‘ä»¬å·²ç»åœ¨è®¨è®ºç»ˆæ­¢åº”ç”¨ç¨‹åºçš„è¿›ç¨‹ä¿¡å·ï¼Œè®©æˆ‘ä»¬ç¡®ä¿ä»¥ä¸ä¸­æ–­ç”¨æˆ·çš„æ–¹å¼æ­£ç¡®ä¸”ä¼˜é›…åœ°å…³é—­å®ƒä»¬ã€‚

å½“ Node.js åº”ç”¨ç¨‹åºæ¥æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼ˆä¹Ÿç§°ä¸º `SIGINT` æˆ– `CTRL+C`ï¼‰æ—¶ï¼Œé™¤éè®¾ç½®äº†ä»»ä½•äº‹ä»¶å¤„ç†ç¨‹åºä»¥ä¸åŒæ–¹å¼å¤„ç†ï¼Œå¦åˆ™å°†å¯¼è‡´è¿›ç¨‹çªç„¶ç»ˆæ­¢ã€‚è¿™æ„å‘³ç€è¿æ¥åˆ° Web åº”ç”¨ç¨‹åºçš„å®¢æˆ·ç«¯å°†ç«‹å³æ–­å¼€è¿æ¥ã€‚ç°åœ¨ï¼Œæƒ³è±¡ä¸€ä¸‹ç”± Kubernetes ç¼–æ’çš„æ•°ç™¾ä¸ª Node.js Web å®¹å™¨ï¼Œæ ¹æ®éœ€è¦ä¸Šä¸‹æ‰©å±•ä»¥ç®¡ç†é”™è¯¯ã€‚è¿™ä¸æ˜¯æœ€ä½³çš„ç”¨æˆ·ä½“éªŒã€‚

æ‚¨å¯ä»¥è½»æ¾æ¨¡æ‹Ÿè¿™ä¸ªé—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¸¦æœ‰ 60 ç§’ç«¯ç‚¹å»¶è¿Ÿå“åº”çš„ Fastify Web åº”ç”¨ç¨‹åºç¤ºä¾‹ï¼š

    fastify.get('/delayed', async (request, reply) => {
     const SECONDS_DELAY = 60000
     await new Promise(resolve => {
         setTimeout(() => resolve(), SECONDS_DELAY)
     })
     return { hello: 'delayed world' }
    })
     
    const start = async () => {
     try {
       await fastify.listen(PORT, HOST)
       console.log(`*^!@4=> Process id: ${process.pid}`)
     } catch (err) {
       fastify.log.error(err)
       process.exit(1)
     }
    }
     
    start()

è¿è¡Œæ­¤åº”ç”¨ç¨‹åºï¼Œä¸€æ—¦è¿è¡Œï¼Œå‘æ­¤ç«¯ç‚¹å‘é€ç®€å•çš„ HTTP è¯·æ±‚ï¼š

`$ time curl https://localhost:3000/delayed`

åœ¨ Node.js æ§åˆ¶å°çª—å£ä¸­æŒ‰ `CTRL+C`ï¼Œæ‚¨ä¼šå‘ç° curl è¯·æ±‚çªç„¶é€€å‡ºã€‚è¿™æ¨¡æ‹Ÿäº†å®¹å™¨æ‹†é™¤æ—¶ç”¨æˆ·å°†ä½“éªŒåˆ°çš„æƒ…å†µã€‚

ä¸ºæä¾›æ›´å¥½çš„ä½“éªŒï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. ä¸ºå„ç§ç»ˆæ­¢ä¿¡å·ï¼ˆå¦‚ `SIGINT` å’Œ `SIGTERM`ï¼‰è®¾ç½®äº‹ä»¶å¤„ç†ç¨‹åºã€‚
2. å¤„ç†ç¨‹åºç­‰å¾…æ¸…ç†æ“ä½œï¼Œå¦‚æ•°æ®åº“è¿æ¥ã€æ­£åœ¨è¿›è¡Œçš„ HTTP è¯·æ±‚ç­‰ã€‚
3. å¤„ç†ç¨‹åºéšåç»ˆæ­¢ Node.js è¿›ç¨‹ã€‚

å…·ä½“å¯¹äº Fastifyï¼Œæˆ‘ä»¬å¯ä»¥è®©å¤„ç†ç¨‹åºè°ƒç”¨ [fastify.close()](https://www.fastify.io/docs/latest/Server/)ï¼Œå®ƒè¿”å›ä¸€ä¸ªæˆ‘ä»¬å°†ç­‰å¾…çš„ promiseï¼Œå¹¶ä¸” Fastify è¿˜ä¼šè´Ÿè´£å¯¹æ¯ä¸ªæ–°è¿æ¥ä»¥ HTTP çŠ¶æ€ç  503 å“åº”ï¼Œä»¥è¡¨ç¤ºåº”ç”¨ç¨‹åºä¸å¯ç”¨ã€‚

è®©æˆ‘ä»¬æ·»åŠ äº‹ä»¶å¤„ç†ç¨‹åºï¼š

    async function closeGracefully(signal) {
       console.log(`*^!@4=> Received signal to terminate: ${signal}`)
     
       await fastify.close()
       // await db.close() å¦‚æœæˆ‘ä»¬åœ¨æ­¤åº”ç”¨ç¨‹åºä¸­æœ‰æ•°æ®åº“è¿æ¥
       // await å…¶ä»–æˆ‘ä»¬åº”è¯¥ä¼˜é›…æ¸…ç†çš„äº‹é¡¹
       process.exit()
    }
    process.on('SIGINT', closeGracefully)
    process.on('SIGTERM', closeGracefully)

è¯šç„¶ï¼Œè¿™æ›´å¤šæ˜¯ä¸€ä¸ªé€šç”¨çš„ Web åº”ç”¨ç¨‹åºé—®é¢˜ï¼Œè€Œé Dockerfile ç›¸å…³ï¼Œä½†åœ¨ç¼–æ’ç¯å¢ƒä¸­æ›´ä¸ºé‡è¦ã€‚

## 7) æŸ¥æ‰¾å¹¶ä¿®å¤ Node.js Docker é•œåƒä¸­çš„å®‰å…¨æ¼æ´

è¯·å‚é˜… [Docker å®‰å…¨å¤‡å¿˜å½• - ä½¿ç”¨é™æ€åˆ†æå·¥å…·](https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html#rule-9-use-static-analysis-tools)

## 8) ä½¿ç”¨å¤šé˜¶æ®µæ„å»º

å¤šé˜¶æ®µæ„å»ºæ˜¯ä¸€ç§å¾ˆå¥½çš„æ–¹å¼ï¼Œå¯ä»¥ä»ç®€å•ä½†å¯èƒ½æœ‰é”™è¯¯çš„ Dockerfile è½¬å˜ä¸ºåˆ†ç¦»çš„ Docker é•œåƒæ„å»ºæ­¥éª¤ï¼Œä»¥é¿å…æ³„éœ²æ•æ„Ÿä¿¡æ¯ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨æ›´å¤§çš„ Docker åŸºç¡€é•œåƒæ¥å®‰è£…ä¾èµ–ã€ç¼–è¯‘ä»»ä½•æœ¬åœ° npm åŒ…ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œç„¶åå°†æ‰€æœ‰è¿™äº›å·¥ä»¶å¤åˆ¶åˆ°ä¸€ä¸ªå°å‹ç”Ÿäº§åŸºç¡€é•œåƒä¸­ï¼Œå°±åƒæˆ‘ä»¬çš„ alpine ç¤ºä¾‹ä¸€æ ·ã€‚

### é˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²

è¿™é‡Œé¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²çš„ç”¨ä¾‹æ¯”æ‚¨æƒ³è±¡çš„æ›´å¸¸è§ã€‚

å¦‚æœæ‚¨ä¸ºå·¥ä½œæ„å»º Docker é•œåƒï¼Œå¾ˆé«˜çš„å¯èƒ½æ€§æ˜¯æ‚¨è¿˜ç»´æŠ¤ç§æœ‰ npm åŒ…ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½éœ€è¦æ‰¾åˆ°æŸç§æ–¹æ³•ä½¿ç§˜å¯†çš„ `NPM_TOKEN` å¯¹ npm å®‰è£…å¯ç”¨ã€‚

ä»¥ä¸‹æ˜¯æˆ‘æ‰€è¯´çš„ç¤ºä¾‹ï¼š

    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    RUN apk add dumb-init
    ENV NODE_ENV production
    ENV NPM_TOKEN 1234
    WORKDIR /usr/src/app
    COPY --chown=node:node . .
    #RUN npm ci --omit=dev
    RUN echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc && \
       npm ci --omit=dev
    USER node
    CMD ["dumb-init", "node", "server.js"]

è¿™æ ·åšä¼šåœ¨ Docker é•œåƒä¸­ç•™ä¸‹åŒ…å«ç§˜å¯† npm ä»¤ç‰Œçš„ `.npmrc` æ–‡ä»¶ã€‚æ‚¨å¯ä»¥å°è¯•é€šè¿‡ä¹‹ååˆ é™¤å®ƒæ¥æ”¹è¿›ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    RUN echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc && \
       npm ci --omit=dev
    RUN rm -rf .npmrc

ç„¶è€Œï¼Œç°åœ¨ `.npmrc` æ–‡ä»¶åœ¨ Docker é•œåƒçš„ä¸åŒå±‚ä¸­å¯ç”¨ã€‚å¦‚æœæ­¤ Docker é•œåƒæ˜¯å…¬å¼€çš„ï¼Œæˆ–è€…æœ‰äººä»¥æŸç§æ–¹å¼è®¿é—®å®ƒï¼Œé‚£ä¹ˆæ‚¨çš„ä»¤ç‰Œå°±ä¼šè¢«æ³„éœ²ã€‚æ›´å¥½çš„æ”¹è¿›æ–¹æ³•å¦‚ä¸‹ï¼š

    RUN echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc && \
       npm ci --omit=dev; \
       rm -rf .npmrc

ç°åœ¨é—®é¢˜æ˜¯ Dockerfile æœ¬èº«éœ€è¦è¢«è§†ä¸ºç§˜å¯†èµ„äº§ï¼Œå› ä¸ºå®ƒåŒ…å«äº†å†…éƒ¨çš„ç§˜å¯† npm ä»¤ç‰Œã€‚

å¹¸è¿çš„æ˜¯ï¼ŒDocker æ”¯æŒåœ¨æ„å»ºè¿‡ç¨‹ä¸­ä¼ é€’å‚æ•°ï¼š

    ARG NPM_TOKEN
    RUN echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc && \
       npm ci --omit=dev; \
       rm -rf .npmrc

ç„¶åæˆ‘ä»¬è¿™æ ·æ„å»ºï¼š

**`$ docker build . -t nodejs-tutorial --build-arg NPM_TOKEN=1234`**

æˆ‘çŸ¥é“æ‚¨è®¤ä¸ºæ­¤æ—¶æˆ‘ä»¬å·²ç»å®Œæˆäº†ï¼Œä½†å¾ˆæŠ±æ­‰è®©æ‚¨å¤±æœ› ğŸ™‚

è¿™å°±æ˜¯å®‰å…¨æ€§ - æœ‰æ—¶çœ‹ä¼¼æ˜æ˜¾çš„äº‹æƒ…å´æ˜¯å¦ä¸€ä¸ªé™·é˜±ã€‚

ç°åœ¨æ‚¨æƒ³çŸ¥é“é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿä¼ é€’ç»™ Docker çš„æ„å»ºå‚æ•°ä¼šä¿ç•™åœ¨å†å²æ—¥å¿—ä¸­ã€‚è®©æˆ‘ä»¬ç”¨è‡ªå·±çš„çœ¼ç›çœ‹çœ‹ã€‚è¿è¡Œæ­¤å‘½ä»¤ï¼š

**`$ docker history nodejs-tutorial`**

å®ƒä¼šæ‰“å°ä»¥ä¸‹å†…å®¹ï¼š

    IMAGE          CREATED              CREATED BY                                      SIZE      COMMENT
    b4c2c78acaba   About a minute ago   CMD ["dumb-init" "node" "server.js"]            0B        buildkit.dockerfile.v0
    <missing>      About a minute ago   USER node                                       0B        buildkit.dockerfile.v0
    <missing>      About a minute ago   RUN |1 NPM_TOKEN=1234 /bin/sh -c echo "//regâ€¦   5.71MB    buildkit.dockerfile.v0
    <missing>      About a minute ago   ARG NPM_TOKEN                                   0B        buildkit.dockerfile.v0
    <missing>      About a minute ago   COPY . . # buildkit                             15.3kB    buildkit.dockerfile.v0
    <missing>      About a minute ago   WORKDIR /usr/src/app                            0B        buildkit.dockerfile.v0
    <missing>      About a minute ago   ENV NODE_ENV=production                         0B        buildkit.dockerfile.v0
    <missing>      About a minute ago   RUN /bin/sh -c apk add dumb-init # buildkit     1.65MB    buildkit.dockerfile.v0

æ‚¨çœ‹åˆ°ç§˜å¯† npm ä»¤ç‰Œäº†å—ï¼Ÿè¿™å°±æ˜¯æˆ‘çš„æ„æ€ã€‚

æœ‰ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•æ¥ç®¡ç†å®¹å™¨é•œåƒçš„ç§˜å¯†ï¼Œä½†ç°åœ¨æ˜¯æ—¶å€™å¼•å…¥å¤šé˜¶æ®µæ„å»ºä½œä¸ºç¼“è§£æ­¤é—®é¢˜çš„æ–¹æ³•ï¼ŒåŒæ—¶å±•ç¤ºæˆ‘ä»¬å¦‚ä½•æ„å»ºæœ€å°çš„é•œåƒã€‚

### ä¸º Node.js Docker é•œåƒå¼•å…¥å¤šé˜¶æ®µæ„å»º

å°±åƒè½¯ä»¶å¼€å‘ä¸­çš„å…³æ³¨ç‚¹åˆ†ç¦»åŸåˆ™ä¸€æ ·ï¼Œæˆ‘ä»¬å°†åœ¨æ„å»º Node.js Docker é•œåƒæ—¶åº”ç”¨ç›¸åŒçš„æ€æƒ³ã€‚æˆ‘ä»¬å°†æœ‰ä¸€ä¸ªé•œåƒç”¨äºæ„å»º Node.js åº”ç”¨ç¨‹åºè¿è¡Œæ‰€éœ€çš„æ‰€æœ‰å†…å®¹ï¼Œåœ¨ Node.js ä¸–ç•Œä¸­ï¼Œè¿™æ„å‘³ç€å®‰è£… npm åŒ…ï¼Œå¹¶åœ¨å¿…è¦æ—¶ç¼–è¯‘æœ¬åœ° npm æ¨¡å—ã€‚è¿™å°†æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€é˜¶æ®µã€‚

ç¬¬äºŒä¸ª Docker é•œåƒï¼Œä»£è¡¨ Docker æ„å»ºçš„ç¬¬äºŒé˜¶æ®µï¼Œå°†æ˜¯ç”Ÿäº§ Docker é•œåƒã€‚è¿™ç¬¬äºŒä¸ªä¹Ÿæ˜¯æœ€åä¸€ä¸ªé˜¶æ®µæ˜¯æˆ‘ä»¬å®é™…ä¼˜åŒ–å¹¶å‘å¸ƒåˆ°æ³¨å†Œè¡¨ï¼ˆå¦‚æœæœ‰ï¼‰çš„é•œåƒã€‚æˆ‘ä»¬å°†ç§°ä¸º `build` çš„ç¬¬ä¸€ä¸ªé•œåƒå°†è¢«ä¸¢å¼ƒï¼Œå¹¶åœ¨æ„å»ºå®ƒçš„ Docker ä¸»æœºä¸Šä¿ç•™ä¸ºæ‚¬ç©ºé•œåƒï¼Œç›´åˆ°è¢«æ¸…ç†ã€‚

ä»¥ä¸‹æ˜¯ä»£è¡¨æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢è¿›å±•çš„ Dockerfile æ›´æ–°ï¼Œä½†åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

    # --------------> æ„å»ºé•œåƒ
    FROM node:latest AS build
    ARG NPM_TOKEN
    WORKDIR /usr/src/app
    COPY package*.json /usr/src/app/
    RUN echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc && \
       npm ci --omit=dev && \
       rm -f .npmrc
     
    # --------------> ç”Ÿäº§é•œåƒ
    FROM node:lts-alpine@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    RUN apk add dumb-init
    ENV NODE_ENV production
    USER node
    WORKDIR /usr/src/app
    COPY --chown=node:node --from=build /usr/src/app/node_modules /usr/src/app/node_modules
    COPY --chown=node:node . /usr/src/app
    CMD ["dumb-init", "node", "server.js"]

å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä¸º `build` é˜¶æ®µé€‰æ‹©äº†ä¸€ä¸ªæ›´å¤§çš„é•œåƒï¼Œå› ä¸ºæˆ‘å¯èƒ½éœ€è¦åƒ `gcc`ï¼ˆGNU ç¼–è¯‘å™¨é›†åˆï¼‰è¿™æ ·çš„å·¥å…·æ¥ç¼–è¯‘æœ¬åœ° npm åŒ…ï¼Œæˆ–è€…ç”¨äºå…¶ä»–éœ€æ±‚ã€‚

åœ¨ç¬¬äºŒé˜¶æ®µï¼Œ`COPY` æŒ‡ä»¤æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è¡¨ç¤ºæ³•ï¼Œå°† `node_modules/` æ–‡ä»¶å¤¹ä»æ„å»º Docker é•œåƒå¤åˆ¶åˆ°è¿™ä¸ªæ–°çš„ç”Ÿäº§åŸºç¡€é•œåƒä¸­ã€‚

å¦å¤–ï¼Œç°åœ¨æ‚¨çœ‹åˆ°ä½œä¸ºæ„å»ºå‚æ•°ä¼ é€’ç»™ `build` ä¸­é—´ Docker é•œåƒçš„ `NPM_TOKEN` äº†å—ï¼Ÿå®ƒåœ¨ `docker history nodejs-tutorial` å‘½ä»¤è¾“å‡ºä¸­ä¸å†å¯è§ï¼Œå› ä¸ºå®ƒä¸å­˜åœ¨äºæˆ‘ä»¬çš„ç”Ÿäº§ Docker é•œåƒä¸­ã€‚

## 9) å°†ä¸å¿…è¦çš„æ–‡ä»¶æ’é™¤åœ¨ Node.js Docker é•œåƒä¹‹å¤–

æ‚¨æœ‰ä¸€ä¸ª `.gitignore` æ–‡ä»¶ï¼Œä»¥é¿å…ç”¨ä¸å¿…è¦çš„æ–‡ä»¶ï¼ˆå¯èƒ½è¿˜æœ‰æ•æ„Ÿæ–‡ä»¶ï¼‰æ±¡æŸ“ git ä»“åº“ï¼Œå¯¹å—ï¼Ÿå¯¹äº Docker é•œåƒä¹Ÿæ˜¯å¦‚æ­¤ã€‚

Docker æœ‰ä¸€ä¸ª `.dockerignore`ï¼Œå®ƒå°†ç¡®ä¿è·³è¿‡å‘é€ä»»ä½•ä¸å…¶ä¸­çš„ glob æ¨¡å¼åŒ¹é…çš„æ–‡ä»¶åˆ° Docker å®ˆæŠ¤è¿›ç¨‹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨ï¼Œè®©æ‚¨äº†è§£å¯èƒ½æ”¾å…¥ Docker é•œåƒä½†ç†æƒ³æƒ…å†µä¸‹åº”é¿å…çš„æ–‡ä»¶ï¼š

    .dockerignore
    node_modules
    npm-debug.log
    Dockerfile
    .git
    .gitignore

å¦‚æ‚¨æ‰€è§ï¼Œ`node_modules/` å®é™…ä¸Šéå¸¸é‡è¦ï¼Œéœ€è¦è·³è¿‡ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬æ²¡æœ‰å¿½ç•¥å®ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ€åˆçš„ç®€å• Dockerfile ç‰ˆæœ¬ä¼šå¯¼è‡´æœ¬åœ° `node_modules/` æ–‡ä»¶å¤¹åŸæ ·å¤åˆ¶åˆ°å®¹å™¨ä¸­ã€‚

    FROM node@sha256:b2da3316acdc2bec442190a1fe10dc094e7ba4121d029cb32075ff59bb27390a
    WORKDIR /usr/src/app
    COPY . /usr/src/app
    RUN npm install
    CMD "npm" "start"

äº‹å®ä¸Šï¼Œåœ¨å®è·µå¤šé˜¶æ®µ Docker æ„å»ºæ—¶ï¼Œæ‹¥æœ‰ `.dockerignore` æ–‡ä»¶å˜å¾—æ›´åŠ é‡è¦ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ç¬¬äºŒé˜¶æ®µ Docker æ„å»ºçš„æ ·å­ï¼š

    # --------------> ç”Ÿäº§é•œåƒ
    FROM node:lts-alpine
    RUN apk add dumb-init
    ENV NODE_ENV production
    USER node
    WORKDIR /usr/src/app
    COPY --chown=node:node --from=build /usr/src/app/node_modules /usr/src/app/node_modules
    COPY --chown=node:node . /usr/src/app
    CMD ["dumb-init", "node", "server.js"]

æ‹¥æœ‰ `.dockerignore` çš„é‡è¦æ€§åœ¨äºï¼Œå½“æˆ‘ä»¬åœ¨ç¬¬äºŒé˜¶æ®µ Dockerfile ä¸­æ‰§è¡Œ `COPY . /usr/src/app` æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå°†ä»»ä½•æœ¬åœ° `node_modules/` å¤åˆ¶åˆ° Docker é•œåƒä¸­ã€‚è¿™æ˜¯ç»å¯¹ä¸è¡Œçš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ä¼šå¤åˆ¶ `node_modules/` ä¸­ä¿®æ”¹è¿‡çš„æºä»£ç ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨é€šé…ç¬¦ `COPY .`ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜ä¼šå°†åŒ…å«å‡­æ®æˆ–æœ¬åœ°é…ç½®çš„æ•æ„Ÿæ–‡ä»¶å¤åˆ¶åˆ° Docker é•œåƒä¸­ã€‚

å¯¹äº `.dockerignore` æ–‡ä»¶ï¼Œè¦ç‚¹æ˜¯ï¼š

- è·³è¿‡ Docker é•œåƒä¸­å¯èƒ½è¢«ä¿®æ”¹çš„ `node_modules/` å‰¯æœ¬ã€‚
- é¿å…å‡­æ®æ³„éœ²ï¼Œå¦‚ `.env` æˆ– `aws.json` æ–‡ä»¶ä¸­çš„å†…å®¹è¿›å…¥ Node.js Docker é•œåƒã€‚
- å¸®åŠ©åŠ é€Ÿ Docker æ„å»ºï¼Œå› ä¸ºå®ƒå¿½ç•¥äº†åŸæœ¬ä¼šå¯¼è‡´ç¼“å­˜å¤±æ•ˆçš„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¿®æ”¹äº†æ—¥å¿—æ–‡ä»¶æˆ–æœ¬åœ°ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼Œéƒ½ä¼šå¯¼è‡´ Docker é•œåƒç¼“å­˜åœ¨å¤åˆ¶æœ¬åœ°ç›®å½•çš„é‚£ä¸€å±‚å¤±æ•ˆã€‚

## 10) å°†ç§˜å¯†æŒ‚è½½åˆ° Docker æ„å»ºé•œåƒä¸­

å…³äº `.dockerignore` æ–‡ä»¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å®ƒæ˜¯ä¸€ç§å…¨æœ‰æˆ–å…¨æ— çš„æ–¹æ³•ï¼Œåœ¨ Docker å¤šé˜¶æ®µæ„å»ºä¸­æ— æ³•é’ˆå¯¹æ¯ä¸ªæ„å»ºé˜¶æ®µå¼€å¯æˆ–å…³é—­ã€‚

ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æ„å»ºé˜¶æ®µä½¿ç”¨ `.npmrc` æ–‡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½éœ€è¦å®ƒæ¥è®¿é—®ç§æœ‰ npm åŒ…çš„ç§˜å¯† npm ä»¤ç‰Œã€‚ä¹Ÿè®¸å®ƒè¿˜éœ€è¦ç‰¹å®šçš„ä»£ç†æˆ–æ³¨å†Œè¡¨é…ç½®æ¥æ‹‰å–åŒ…ã€‚

è¿™æ„å‘³ç€åœ¨ `build` é˜¶æ®µæä¾› `.npmrc` æ–‡ä»¶æ˜¯æœ‰æ„ä¹‰çš„ - ç„¶è€Œï¼Œåœ¨ç”Ÿäº§é•œåƒçš„ç¬¬äºŒé˜¶æ®µï¼Œæˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦å®ƒï¼Œä¹Ÿä¸å¸Œæœ›å®ƒåœ¨é‚£é‡Œï¼Œå› ä¸ºå®ƒå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ç§˜å¯† npm ä»¤ç‰Œã€‚

ç¼“è§£è¿™ä¸ª `.dockerignore` ç¼ºé™·çš„ä¸€ç§æ–¹æ³•æ˜¯æŒ‚è½½æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æœ‰ä¸€ç§æ›´å¥½çš„æ–¹æ³•ã€‚

Docker æ”¯æŒä¸€ç§ç›¸å¯¹è¾ƒæ–°çš„åŠŸèƒ½ï¼Œç§°ä¸º Docker ç§˜å¯†ï¼Œè¿™æ­£å¥½é€‚åˆæˆ‘ä»¬å¤„ç† `.npmrc` çš„æƒ…å†µã€‚å…¶å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

- è¿è¡Œ `docker build` å‘½ä»¤æ—¶ï¼Œæˆ‘ä»¬å°†æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°ï¼Œå®šä¹‰ä¸€ä¸ªæ–°çš„ç§˜å¯† ID å¹¶å¼•ç”¨æ–‡ä»¶ä½œä¸ºç§˜å¯†çš„æºã€‚
- åœ¨ Dockerfile ä¸­ï¼Œæˆ‘ä»¬å°†ä¸º `RUN` æŒ‡ä»¤æ·»åŠ æ ‡å¿—ï¼Œä»¥å®‰è£…ç”Ÿäº§ npmï¼Œè¿™å°†æŒ‚è½½ç”±ç§˜å¯† ID å¼•ç”¨çš„æ–‡ä»¶åˆ°ç›®æ ‡ä½ç½® - æœ¬åœ°ç›®å½• `.npmrc` æ–‡ä»¶ï¼Œè¿™æ˜¯æˆ‘ä»¬å¸Œæœ›å®ƒå¯ç”¨çš„åœ°æ–¹ã€‚
- `.npmrc` æ–‡ä»¶ä½œä¸ºç§˜å¯†æŒ‚è½½ï¼Œæ°¸è¿œä¸ä¼šå¤åˆ¶åˆ° Docker é•œåƒä¸­ã€‚
- æœ€åï¼Œåˆ«å¿˜äº†å°† `.npmrc` æ–‡ä»¶æ·»åŠ åˆ° `.dockerignore` æ–‡ä»¶çš„å†…å®¹ä¸­ï¼Œä»¥ç¡®ä¿å®ƒæ ¹æœ¬ä¸ä¼šè¿›å…¥é•œåƒï¼Œæ— è®ºæ˜¯æ„å»ºè¿˜æ˜¯ç”Ÿäº§é•œåƒã€‚

è®©æˆ‘ä»¬çœ‹çœ‹æ‰€æœ‰è¿™äº›æ˜¯å¦‚ä½•ååŒå·¥ä½œçš„ã€‚é¦–å…ˆæ˜¯æ›´æ–°åçš„ `.dockerignore` æ–‡ä»¶ï¼š

    .dockerignore
    node_modules
    npm-debug.log
    Dockerfile
    .git
    .gitignore
    .npmrc

ç„¶åæ˜¯å®Œæ•´çš„ Dockerfileï¼Œæ›´æ–°äº† RUN æŒ‡ä»¤ä»¥åœ¨æŒ‡å®š `.npmrc` æŒ‚è½½ç‚¹çš„åŒæ—¶å®‰è£… npm åŒ…ï¼š

    # --------------> æ„å»ºé•œåƒ
    FROM node:latest AS build
    WORKDIR /usr/src/app
    COPY package*.json /usr/src/app/
    RUN --mount=type=secret,mode=0644,id=npmrc,target=/usr/src/app/.npmrc npm ci --omit=dev
     
    # --------------> ç”Ÿäº§é•œåƒ
    FROM node:lts-alpine
    RUN apk add dumb-init
    ENV NODE_ENV production
    USER node
    WORKDIR /usr/src/app
    COPY --chown=node:node --from=build /usr/src/app/node_modules /usr/src/app/node_modules
    COPY --chown=node:node . /usr/src/app
    CMD ["dumb-init", "node", "server.js"]

æœ€åï¼Œæ„å»º Node.js Docker é•œåƒçš„å‘½ä»¤ï¼š

    docker build . -t nodejs-tutorial --secret id=npmrc,src=.npmrc

**æ³¨æ„ï¼š** ç§˜å¯†æ˜¯ Docker çš„ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æ—§ç‰ˆæœ¬ï¼Œå¯èƒ½éœ€è¦æŒ‰å¦‚ä¸‹æ–¹å¼å¯ç”¨ Buildkitï¼š

    DOCKER_BUILDKIT=1 docker build . -t nodejs-tutorial --build-arg NPM_TOKEN=1234 --secret id=npmrc,src=.npmrc
