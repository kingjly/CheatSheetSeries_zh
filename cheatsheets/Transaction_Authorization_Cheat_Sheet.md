# 交易授权备忘录

## 目的和受众

本备忘录讨论开发者如何保护交易授权并防止其被绕过。这些指南适用于：

- **银行** - 需要为交易授权创建功能性和非功能性需求。
- **开发者** - 需要消除交易授权中的漏洞。
- **渗透测试人员** - 必须确定交易授权是否安全。

## 引言

通常，移动和在线应用程序要求用户提交第二因素，以便系统检查他们是否有权执行敏感操作（如电汇授权）。在本文档中，我们将这些操作称为*交易授权*。

交易授权经常用于金融系统，但对安全交易的需求已推动授权在互联网上的广泛应用。例如，一封允许用户通过提供秘密代码或带有令牌的链接来解锁用户账户的电子邮件也包含交易授权。交易授权可以通过以下方法实现：

- 具有交易授权号码的卡片
- 基于时间的一次性密码（OTP）令牌，如 [OATH TOTP（基于时间的一次性密码）](https://en.wikipedia.org/wiki/Time-based_One-time_Password_Algorithm)
- 通过短信发送或通过电话提供的 OTP
- 由智能卡或智能手机提供的数字签名
- 挑战-响应令牌，包括非连接读卡器或从用户计算机屏幕扫描交易数据的解决方案

这些交易授权形式可以通过物理设备或移动应用程序实现。

## 1. 功能指南

### 1.1 交易授权方法必须允许用户识别和确认重要的交易数据

由于开发者不能假设用户的计算机是安全的，外部授权组件必须检查典型交易的数据。

当开发者构建交易授权组件时，应使用*所见即所签*原则。授权方法必须允许用户识别和确认对给定交易重要的数据。例如，在电汇的情况下，用户应能识别目标账户和金额。

开发者在确定重要交易数据时，应基于以下考虑：

- 实际风险
- 所选授权方法的技术能力和约束
- 用户获得正面体验

例如，如果短信确认重要的交易数据，开发者可以向用户返回目标账户、金额和转账类型。然而，对于非连接的 [CAP 读卡器](https://en.wikipedia.org/wiki/Chip_Authentication_Program)，要求用户输入这些数据是不方便的。在这种情况下，开发者可能应返回最少量的重要交易数据（例如部分目标账户号码和金额）以供确认。

通常，用户必须在交易授权过程中验证所有重要的交易数据。如果交易过程要求用户在外部设备中输入交易数据，则应提示用户确认交易中的特定值（例如目标账户号码）。缺乏有意义的提示可能很容易被社会工程技术和恶意软件滥用，如下文 1.4 节所述。关于输入溢出问题的更详细讨论，请参见[此处](http://www.cl.cam.ac.uk/~sjm217/papers/fc09optimised.pdf)。

### 1.2 更改授权令牌应使用当前授权令牌进行授权

如果用户可以使用应用程序界面更改授权令牌，他们应能使用当前授权凭据授权该操作（类似于[密码更改程序](https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/04-Authentication_Testing/09-Testing_for_Weak_Password_Change_or_Reset_Functionalities.html)）。例如：当用户更改短信码的电话号码时，授权短信码应发送到当前电话号码。

### 1.3 更改授权方法应使用当前授权方法进行授权

某些应用程序允许用户选择交易授权方式。在这种情况下，开发者应确保应用程序可以确认用户的授权方法，以防止任何恶意软件将用户的授权方法更改为最脆弱的方法。此外，应用程序应告知用户与其授权方法相关的潜在危险。

### 1.4 用户应能轻松区分认证过程和交易授权过程

由于开发者需要防止用户授权欺诈操作，他们的应用程序不应要求用户对认证和交易授权执行相同的操作。考虑以下示例：

1. 应用程序对用户认证和交易授权使用相同的方法（即使用 OTP 令牌）。
2. 恶意软件可以使用中间人攻击，在用户向应用程序提交凭据时显示虚假错误消息，这可能诱使用户重复认证程序。第一个凭据将被恶意软件用于认证，第二个凭据将用于授权欺诈交易。即使是挑战-响应方案也可能被滥用，因为恶意软件可以提供来自欺诈交易的挑战，并诱骗用户提供响应。这种攻击场景在[针对电子银行的恶意软件攻击](http://securityintelligence.com/back-basics-malware-authors-downgrade-tactics-stay-radar/#.VX_qI_krLDc)中被广泛使用。

为阻止此类攻击，开发者可以通过以下方式确保认证操作与交易授权不同：

- 使用不同的方法进行认证和授权
- 在外部安全组件中采用不同的操作（即在 CAP 读卡器中使用不同的操作模式）
- 向用户清晰地展示他们正在"签署"的内容（所见即所签原则）

尽管[社会工程方法可以绕过认证和操作授权方法](http://securityintelligence.com/tatanga-attack-exposes-chiptan-weaknesses/#.VZAy9PkrLDc)，但应用程序不应使这种攻击场景变得更容易。

### 1.5 每笔交易应使用唯一的授权凭据

如果应用程序仅要求一次交易授权凭据（如静态密码、通过短信发送的代码或令牌响应），用户可以在整个会话期间授权任何交易，或在需要授权交易时重复使用相同的凭据。在这种情况下，攻击者可以使用恶意软件嗅探凭据并在用户不知情的情况下授权任何交易。

## 2. 非功能性指南

### 2.1 授权应在服务器端执行和强制

与[所有其他安全控制](https://cwe.mitre.org/data/definitions/602.html)一样，交易授权应在服务器端强制执行。通过以下方式更改从客户端到服务器的数据，**绝不**应该影响授权结果：

- 篡改包含交易数据的参数
- 添加/删除参数以禁用授权检查
- 引发错误

为确保数据仅在服务器端管理，应应用安全编程最佳实践，例如：

- [默认拒绝](https://wiki.owasp.org/index.php/Positive_security_model)
- 避免在生产代码中使用调试功能

还应考虑其他防篡改保护措施，如加密数据以确保机密性和完整性，然后在服务器端解密和验证数据。

### 2.2 授权方法应在服务器端强制执行

如果为用户提供多种交易授权方法，服务器端必须确保交易使用用户选择的授权方法或应用程序策略强制的授权方法。否则，恶意软件可能会将授权方法降级到最不安全的授权方法。开发者必须使攻击者无法通过操纵客户端提供的参数来更改所选授权方法。

如果要求开发者添加增强安全性的新授权方法，他们应特别小心。不幸的是，开发者经常决定在旧代码库上构建新的授权方法。这种情况是不安全的，攻击者可以操纵客户端，通过使用旧方法发送参数来成功授权交易，尽管应用程序已切换到新方法。

### 2.3 交易验证数据应在服务器端生成

如果开发者决定以编程方式将重要的交易数据传输到授权组件，他们应格外小心，防止客户端在授权时修改交易数据。**所有重要的交易数据必须由用户验证，在服务器上生成和存储，然后传递给授权组件，且不可能被客户端篡改。**

当开发者在客户端收集重要的交易数据并传递给服务器时，恶意软件可能会操纵数据并在授权组件中显示伪造的交易数据。

### 2.4 应用程序应防止授权凭据暴力破解

**开发者必须确保其应用程序不允许攻击者在向服务器提交交易授权凭据进行验证时暴力破解交易。在一定数量的授权尝试失败后，整个交易授权过程应重新启动。**另外，还有其他方法可以防止暴力破解和停止其他自动化相关技术，请参见 [OWASP 认证备忘录](Authentication_Cheat_Sheet.md#prevent-brute-force-attacks)。

### 2.5 应用程序应控制允许的交易状态转换

交易授权通常分多个步骤执行，例如：

1. 用户输入交易数据。
2. 用户向应用程序请求授权。
3. 应用程序初始化授权机制。
4. 用户验证/确认交易数据。
5. 用户使用授权凭据响应。
6. 应用程序验证授权并执行交易。

**开发者必须确保交易授权的业务逻辑流程按顺序进行，使用户（或攻击者）无法乱序执行步骤或跳过任何步骤。这应防止以下攻击技术：**

- 在用户输入授权凭据之前覆盖交易数据
- 跳过交易授权

参见 [OWASP ASVS](https://owasp.org/www-project-application-security-verification-standard/) 要求 **15.1**。

### 2.6 应保护交易数据免遭修改

开发者不得允许攻击者在用户首次输入数据时修改交易数据。糟糕的实现可能允许恶意软件：

1. 在用户输入授权凭据之前在后台重放第 2.5 节中的第一步（发送交易数据），然后用欺诈性交易覆盖交易详细信息。
2. 在授权交易的 HTTP 请求中创建和添加新的交易数据参数。在这种情况下，实施不当的交易授权过程可能会授权初始交易，然后执行欺诈性交易（[检查时间到使用时间漏洞](https://cwe.mitre.org/data/definitions/367.html)的具体示例）。

有多种方法可以防止在授权期间修改交易数据：

1. 如果修改了交易数据，代码可以使任何先前输入的授权数据（例如生成的 OTP）和挑战失效。
2. 修改交易数据可能触发授权过程重置。
3. 任何在用户输入后尝试修改交易数据的行为都是对系统的攻击，应记录、监控并仔细调查。

### 2.7 应在所有客户端-服务器通信中保护交易数据的机密性

交易授权过程应保护用户将授权的交易数据的隐私（即第 2.5 节中的步骤 2 和 4）。

### 2.8 系统应检查每笔交易执行并确保已正确授权

交易输入和授权过程的最终结果（如第 2.5 节所述）也称为*交易执行*。在交易执行之前应有一个最终控制门，验证交易是否已由用户正确授权。此控制应与执行绑定，并防止以下攻击：

- 检查时间到使用时间（TOCTOU）- 参见第 2.6 节示例
- 在交易输入过程中跳过授权检查（参见第 2.5 节）

### 2.9 授权凭据应仅在有限的时间内有效

在某些攻击中，用户的授权凭据被恶意软件传递给指挥控制服务器，然后在攻击者控制的机器上使用。这个过程通常由攻击者手动执行。为确保这些攻击难以进行，服务器应仅允许在生成挑战（或 OTP）和完成授权之间的有限时间窗口内进行交易授权。此外，这种保护措施还将有助于阻止资源耗尽攻击。这个时间段应仔细选择，以不干扰正常用户行为。

### 2.10 授权凭据对每个操作都应唯一

为防止多次重放攻击，每组授权凭据对每个操作都应唯一。这些凭据可以根据机制使用不同方法生成。例如：开发者可以在签名的交易数据中或作为挑战的一部分使用时间戳、序列号或随机值。

## 备注

以下是实施交易授权时应考虑的一些其他问题，但超出了本备忘录的范围：

- 应授权哪些交易？所有交易还是仅部分交易？每个应用程序都不同，应用程序所有者应决定是授权所有交易还是仅部分交易。开发者应考虑风险分析、给定应用程序的风险暴露以及在应用程序中实施的其他保护措施。
- **我们建议使用加密操作来保护交易并确保完整性、机密性和不可否认性。**
- **在设备"配对"期间提供和保护设备签名密钥与实际签名协议本身同样至关重要。恶意软件可能试图注入/替换或窃取签名密钥。**
- 用户意识：例如在交易授权方法中，当用户在授权组件（如外部专用设备或移动应用程序）中输入重要的交易数据时，应训练用户从可信来源重新输入交易数据，而不是从计算机屏幕上。
- **有一些反恶意软件解决方案可以防范此类威胁，但这些解决方案[无法 100% 有效](http://www.securing.pl/en/script-based-malware-detection-in-online-banking-security-overview/index.html)，应仅作为额外的保护层。**
- 使用第二因素（如密码、生物识别等）保护签名密钥，或利用安全元素（TEE、TPM、智能卡）。

## 参考文献和延伸阅读

- Wojciech Dworakowski：[电子银行交易授权 - 可能的漏洞、安全验证和实施最佳实践。2015 年 AppSec EU 大会演讲](http://www.slideshare.net/wojdwo/ebanking-transaction-authorization-appsec-eu-2015-amsterdam)。
- Saar Drimer, Steven J. Murdoch, 和 Ross Anderson：[优化失败 - 在线银行读卡器](http://www.cl.cam.ac.uk/~sjm217/papers/fc09optimised.pdf)。
- Jakub Kałużny, Mateusz Olejarka：[在线银行安全中基于脚本的恶意软件检测概述](http://www.securing.pl/en/script-based-malware-detection-in-online-banking-security-overview/index.html)。
- [支持双因素认证的网站列表](https://twofactorauth.org/)。
- Laerte Peotta, Marcelo D. Holtz, Bernardo M. David, Flavio G. Deus, Rafael Timóteo de Sousa Jr：[互联网银行攻击和漏洞的正式分类](http://airccse.org/journal/jcsit/0211ijcsit13.pdf)。
- Marco Morana, Tony Ucedavelez：[银行恶意软件攻击的威胁建模](https://owasp.org/www-pdf-archive/Marco_Morana_and_Tony_UV_-_Threat_Modeling_of_Banking_Malware.pdf)。
- OWASP [反恶意软件 - 知识库](https://wiki.owasp.org/index.php/OWASP_Anti-Malware_-_Knowledge_Base)。
- OWASP [反恶意软件项目 - 意识计划](https://wiki.owasp.org/index.php/OWASP_Anti-Malware_Project_-_Awareness_Program)。
- Arjan Blom, Gerhard de Koning Gans, Erik Poll, Joeri de Ruiter, 和 Roel Verdult：[注定失败 - 用于在线银行的 USB 连接读卡器](http://www.cs.ru.nl/~rverdult/Designed_to_Fail_A_USB-Connected_Reader_for_Online_Banking-NORDSEC_2012.pdf)
