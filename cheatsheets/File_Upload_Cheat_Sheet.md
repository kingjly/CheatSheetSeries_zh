# 文件上传备忘录

## 引言

文件上传正变得越来越成为任何应用程序不可或缺的部分，用户可以上传他们的照片、简历或展示项目的视频。应用程序应该能够抵御虚假和恶意文件，以保护应用程序和用户的安全。

简而言之，为了实现安全的文件上传，应遵循以下原则：

- **列出允许的扩展名。仅允许对业务功能至关重要的安全扩展名**
    - **确保在验证扩展名之前应用[输入验证](Input_Validation_Cheat_Sheet.md#file-upload-validation)。**
- **验证文件类型，不要信任可以被伪造的 [Content-Type 标头](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type)**
- **将文件名更改为由应用程序生成的名称**
- **设置文件名长度限制。如果可能，限制允许的字符**
- **设置文件大小限制**
- **仅允许授权用户上传文件**
- **将文件存储在不同的服务器上。如果不可能，则存储在 Web 根目录之外**
    - **对于公开访问的文件，使用映射到应用程序内部文件名的处理程序（某个 ID -> 文件.扩展名）**
- **如果可用，通过防病毒软件或沙盒运行文件，以验证其不包含恶意数据**
- **对适用类型（PDF、DOCX 等）运行 CDR（内容消毒与重建）**
- **确保使用的任何库都安全配置并保持最新**
- **防止文件上传受到 [CSRF](Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md) 攻击**

## 文件上传威胁

为了评估和准确了解要实施的控制措施，了解所面临的威胁对于保护资产至关重要。以下部分将展示文件上传功能所伴随的风险。

### 恶意文件

攻击者出于恶意目的提供文件，例如：

1. 利用文件解析器或处理模块中的漏洞（例如 [ImageTrick 漏洞](https://imagetragick.com/)，[XXE](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_%28XXE%29_Processing)）
2. 用于钓鱼（例如职位申请表）
3. 发送 ZIP 炸弹、XML 炸弹（又称十亿笑声攻击），或简单地发送大文件以填满服务器存储，从而阻碍和损害服务器可用性
4. 覆盖系统上的现有文件
5. 客户端活动内容（XSS、CSRF 等），如果文件可公开检索，可能会危及其他用户

### 公开文件检索

如果上传的文件可公开检索，还可能出现其他威胁：

1. 公开披露其他文件
2. 通过请求大量文件发起拒绝服务（DoS）攻击。请求很小，但响应却大得多
3. 可能被视为非法、攻击性或危险的文件内容（例如个人数据、受版权保护的数据等），这将使您成为此类恶意文件的主机

## 文件上传保护

在验证用户内容方面没有万能的解决方案。实施深度防御方法是使上传过程更加困难和锁定的关键，以满足服务的需求和要求。实施多种技术是关键且推荐的，因为没有一种技术足以保护服务。

### 扩展名验证

确保在解码文件名后进行验证，并设置适当的过滤器以避免某些已知的绕过方式，例如：

- 双重扩展名，例如 `.jpg.php`，可以轻松绕过正则表达式 `\.jpg`
- 空字节，例如 `.php%00.jpg`，其中 `.jpg` 被截断，`.php` 成为新的扩展名
- 未经充分测试和审查的通用错误正则表达式。除非对此主题有足够的知识，否则请避免构建自己的逻辑

请参考[输入验证速查表](Input_Validation_Cheat_Sheet.md)以正确解析和处理扩展名。

#### 列出允许的扩展名

确保仅使用*业务关键*扩展名，不允许任何*非必需*扩展名。例如，如果系统需要：

- 图像上传，允许一种符合业务需求的类型；
- 简历上传，允许 `docx` 和 `pdf` 扩展名。

根据应用程序的需求，确保使用**最不有害**和**风险最低**的文件类型。

#### 阻止扩展名

识别对服务有潜在危害的文件类型，并阻止您认为对服务有害的扩展名。

请注意，仅仅阻止特定扩展名是一种非常弱的保护方法。[无限制文件上传漏洞](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)文章描述了攻击者可能尝试绕过此类检查的方法。

### Content-Type 验证

*上传文件的 Content-Type 由用户提供，因此不可信，因为伪造非常简单。尽管不应依赖它进行安全性，但它可以快速检查以防止用户无意中上传类型不正确的文件。*

除了定义上传文件的扩展名外，还可以检查其 MIME 类型，以快速防止简单的文件上传攻击。

最好采用白名单方法；否则，可以采用黑名单方法。

### 文件签名验证

结合 [Content-Type 验证](#content-type-validation)，可以检查并验证文件签名是否与预期接收的文件相符。

> 不应单独使用，因为绕过它相当常见且容易。

### 文件名安全性

文件名可以通过使用不可接受的字符或使用特殊和受限的文件名来危害系统。对于 Windows，请参考以下 [MSDN 指南](https://docs.microsoft.com/en-us/windows/win32/fileio/naming-a-file?redirectedfrom=MSDN#naming-conventions)。要全面了解不同文件系统如何处理文件，请参考 [Wikipedia 的文件名页面](https://en.wikipedia.org/wiki/Filename)。

为避免上述威胁，创建作为文件名的**随机字符串**（如生成 UUID/GUID）至关重要。如果业务需求需要文件名，则应对客户端（例如导致 XSS 和 CSRF 攻击的活动内容）和后端（例如特殊文件覆盖或创建）攻击向量进行适当的输入验证。应根据存储文件的系统考虑文件名长度限制，因为每个系统都有自己的文件名长度限制。如果需要用户文件名，请考虑实施以下措施：

- 实施最大长度
- 限制字符为特定的允许子集，如字母数字字符、连字符、空格和句点
    - 考虑告诉用户什么是可接受的文件名。
    - 限制使用前导句点（隐藏文件）和连续句点（目录遍历）。
    - 限制使用前导连字符或空格，以使使用 shell 脚本处理文件更安全。
    - 如果不可能，则阻止可能危害框架和存储和使用文件的系统的危险字符。

### 文件内容验证

如[公开文件检索](#public-file-retrieval)部分所述，文件内容可能包含恶意、不当或非法数据。

根据预期类型，可以应用特殊的文件内容验证：

- 对于**图像**，应用图像重写技术可以销毁注入图像的任何恶意内容；这可以通过[随机化](https://security.stackexchange.com/a/8625/118367)来完成。
- 对于 **Microsoft 文档**，使用 [Apache POI](https://poi.apache.org/) 有助于验证上传的文档。
- 不建议使用 **ZIP 文件**，因为它们可以包含各种类型的文件，且与之相关的攻击向量众多。

文件上传服务应允许用户报告非法内容，并允许版权所有者报告滥用。

如果有足够的资源，应在将文件公开发布之前在沙盒环境中进行手动文件审查。

添加一些自动化审查可能会有帮助，这是一个严格的过程，应在使用前进行充分研究。一些服务（例如 Virus Total）提供 API 来扫描文件是否存在众所周知的恶意文件哈希。一些框架可以检查和验证原始内容类型并针对预定义文件类型进行验证，例如在 [ASP.NET 绘图库](https://docs.microsoft.com/en-us/dotnet/api/system.drawing.imaging.imageformat)中。请注意公共服务可能带来的数据泄露和信息收集威胁。

### 文件存储位置

文件存储位置必须根据安全性和业务需求选择。以下几点按安全优先级排序，且是包容的：

1. 将文件存储在**不同的主机**上，这允许应用服务和处理文件上传和存储的主机之间完全职责分离。
2. 将文件存储在 **Web 根目录外**，仅允许管理员访问。
3. 将文件存储在 **Web 根目录内**，并设置仅写权限。
   - 如果需要读取访问权限，则必须设置适当的控制（例如内部 IP、授权用户等）

以数据库方式存储文件是一种额外的技术。这有时用于自动备份过程、防止非文件系统攻击和权限问题。作为回报，这可能导致性能问题（在某些情况下）、数据库及其备份的存储考虑，并可能引入 SQLi 攻击。仅当团队中有数据库管理员且此过程被证明比在文件系统上存储更有改进时，才建议这样做。

> 某些文件在上传后被发送或处理，并不存储在服务器上。在对它们执行任何操作之前，进行本速查表中讨论的安全措施至关重要。

### 用户权限

在访问任何文件上传服务之前，应在两个级别对上传文件的用户进行适当的验证：

- 身份验证级别
    - 用户应该是注册用户或可识别用户，以设置其上传能力的限制和限制
- 授权级别
    - 用户应具有访问或修改文件的适当权限

### 文件系统权限

> 根据最小特权原则设置文件权限。

文件应以确保以下情况的方式存储：

- 仅允许系统用户读取文件
- 仅设置所需的模式
    - 如果需要执行，则在运行之前扫描文件是安全最佳实践，以确保没有宏或隐藏脚本。

### 上传和下载限制

应用程序应为上传服务设置适当的大小限制，以保护文件存储容量。如果系统将提取或处理文件，则文件大小限制应在进行文件解压缩后考虑，并使用安全方法计算 ZIP 文件大小。有关更多信息，请参见如何[安全地从 ZipInputStream 提取文件](https://wiki.sei.cmu.edu/confluence/display/java/IDS04-J.+Safely+extract+files+from+ZipInputStream)，Java 处理 ZIP 文件的输入流。

如果可用，应用程序还应为下载服务设置适当的请求限制，以保护服务器免受 DoS 攻击。

## Java 代码片段

[文档上传保护](https://github.com/righettod/document-upload-protection)仓库由 Dominique 为某些文档类型在 Java 中编写。
