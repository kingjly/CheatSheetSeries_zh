# NPM 安全最佳实践

在以下 npm 备忘录中，我们将重点关注 [10 个 npm 安全最佳实践](https://snyk.io/blog/ten-npm-security-best-practices)和生产力技巧，这对 JavaScript 和 Node.js 开发者很有用。

## 1) 避免将秘密信息发布到 npm 注册表

无论是使用 API 密钥、密码还是其他秘密信息，它们都很容易泄露到源代码控制或公共 npm 注册表中。你可能在工作目录的指定文件（如 `.env`）中有秘密信息，这些文件应该被添加到 `.gitignore` 以避免提交到源代码管理系统，但是当你从项目目录发布 npm 包时会发生什么？

npm CLI 将项目打包成 tar 归档（tarball）以推送到注册表。以下标准决定了哪些文件和目录被添加到 tarball：

- 如果存在 `.gitignore` 或 `.npmignore` 文件，文件内容将用作准备发布包时的忽略模式。
- 如果两个忽略文件都存在，`.npmignore` 中未列出的所有内容都将发布到注册表。这种情况是常见的混淆源，可能导致秘密信息泄露。

开发者可能会更新 `.gitignore` 文件，但忘记同时更新 `.npmignore`，这可能导致敏感文件不会被推送到源代码控制，但仍会包含在 npm 包中。

另一个好的做法是使用 `package.json` 中的 `files` 属性，它作为允许列表，指定要创建和安装的包中要包含的文件数组（而忽略文件则作为拒绝列表）。`files` 属性和忽略文件可以一起使用，以明确指定包中应包含和排除的文件。使用两者时，`package.json` 中的 `files` 属性优先于忽略文件。

发布包时，npm CLI 将详细显示正在创建的归档。为了格外小心，可以在发布命令中添加 `--dry-run` 命令行参数，以便在实际发布到注册表之前先预览 tarball 的创建情况。

2019 年 1 月，npm 在他们的博客上分享，如果检测到在包中发布了令牌，他们会自动撤销该令牌。

## 2) 强制执行锁定文件

我们张开双臂欢迎了锁定文件的诞生，它带来了：跨不同环境的确定性安装，以及跨团队协作的依赖期望强制执行。生活很美好！但是，如果我在项目的 `package.json` 文件中做了更改，却忘记同时提交锁定文件会怎样？

Yarn 和 npm 在依赖安装期间的行为相同。当它们检测到项目的 `package.json` 和锁定文件之间存在不一致时，它们会根据 `package.json` 清单进行补偿，安装与锁定文件中记录的不同的版本。

这种情况对构建和生产环境可能很危险，因为它们可能拉取意外的包版本，从而使锁定文件的整体好处变得徒劳。

幸运的是，有一种方法可以告诉 Yarn 和 npm 遵守锁定文件中引用的特定依赖及其版本。任何不一致都将中止安装。命令行应该如下所示：

- 如果使用 Yarn，运行 `yarn install --frozen-lockfile`。
- 如果使用 npm，运行 `npm ci`。

## 3) 通过忽略运行脚本来最小化攻击面

npm CLI 使用包运行脚本。如果你曾经运行过 `npm start` 或 `npm test`，那么你也使用过包运行脚本。npm CLI 基于包可以声明的脚本构建，并允许包在项目安装的特定入口点定义要运行的脚本。例如，一些[脚本钩子](https://docs.npmjs.com/misc/scripts)条目可能是 `postinstall` 脚本，在安装包时执行以执行日常维护任务。

通过这种功能，恶意行为者可能会创建或更改包，通过在包安装时运行任意命令来执行恶意行为。我们已经看到这种情况发生在流行的 [eslint-scope 事件](https://snyk.io/vuln/npm:eslint-scope:20180712)中，该事件收集了 npm 令牌，以及 [crossenv 事件](https://snyk.io/vuln/npm:crossenv:20170802)，以及另外 36 个在 npm 注册表上滥用拼写错误攻击的包。

应用这些 npm 安全最佳实践以最小化恶意模块攻击面：

- 始终审查和尽职调查你安装的第三方模块，以确认它们的健康和可信度。
- 不要立即升级到新版本；允许新包版本有一些时间流通后再尝试。
- 升级前，确保查看更改日志和发行说明。
- 安装包时，确保添加 `--ignore-scripts` 后缀以禁用第三方包的任何脚本执行。
- 考虑将 `ignore-scripts` 添加到项目的 `.npmrc` 文件或全局 npm 配置中。

## 4) 评估 npm 项目健康状况

### npm outdated 命令

盲目地不断将依赖升级到最新版本并不一定是好的做法，尤其是在不查看发行说明、代码变更和全面测试新升级的情况下。话虽如此，长期不升级或很久才升级同样会带来麻烦。

npm CLI 可以提供关于你使用的依赖相对于其语义版本偏移的新鲜度信息。通过运行 `npm outdated`，你可以看到哪些包已过时。黄色的依赖对应于 `package.json` 清单中指定的语义版本，红色的依赖意味着有可用的更新。此外，输出还显示每个依赖的最新版本。

### npm doctor 命令

在各种 Node.js 包管理器和你可能在路径中安装的不同 Node.js 版本之间，如何验证健康的 npm 安装和工作环境？无论你是在开发环境还是 CI 中使用 npm CLI，确保一切正常工作都很重要。

叫医生来看看！npm CLI 包含一个健康评估工具，用于诊断你的环境是否能顺利使用 npm。运行 `npm doctor` 来检查你的 npm 设置：

- 检查官方 npm 注册表是否可访问，并显示当前配置的注册表。
- 检查 Git 是否可用。
- 检查已安装的 npm 和 Node.js 版本。
- 对本地和全局 `node_modules`，以及用于包缓存的文件夹进行权限检查。
- 检查本地 npm 模块缓存的校验和正确性。

## 5) 审核开源依赖中的漏洞

npm 生态系统是所有语言生态系统中最大的应用库仓库。对于 JavaScript 开发者来说，注册表和其中的库是核心，因为他们能够利用他人已经构建的工作并将其合并到自己的代码库中。话虽如此，在应用程序中越来越多地采用开源库也带来了引入安全漏洞的增加风险。

许多流行的 npm 包被发现存在漏洞，如果没有对项目依赖进行适当的安全审核，可能会带来重大风险。一些例子包括 npm [request](https://snyk.io/vuln/npm:request:20160119)、[superagent](https://snyk.io/vuln/search?q=superagent&type=npm)、[mongoose](https://snyk.io/vuln/search?q=mongoose&type=npm)，甚至安全相关的包如 [jsonwebtoken](https://snyk.io/vuln/npm:jsonwebtoken:20150331) 和 [validator](https://snyk.io/vuln/search?q=validator&type=npm)。

安全性不仅仅在于安装包时扫描安全漏洞，还应该与开发工作流程整合，在整个软件开发生命周期中有效地采用，并在代码部署时持续监控：

- 扫描[第三方开源项目](https://owasp.org/www-community/Component_Analysis)中的安全漏洞
- 监控项目清单的快照，以便在新的 CVE 影响它们时收到警报

## 6) 使用本地 npm 代理

npm 注册表是所有 JavaScript 开发者可用的最大包集合，也是大多数 Web 开发开源项目的家园。但有时你可能在安全性、部署或性能方面有不同的需求。当这是真的时，npm 允许你切换到不同的注册表：

当你运行 `npm install` 时，它会自动开始与主注册表通信以解析所有依赖；如果你希望使用不同的注册表，这也很直接：

- 使用 `npm set registry` 设置默认注册表。
- 使用 `--registry` 参数指定单个注册表。

[Verdaccio](https://verdaccio.org/) 是一个简单的轻量级零配置私有注册表，安装非常简单：`$ npm install --global verdaccio`。

托管自己的注册表从未如此容易！让我们看看这个工具的最重要特性：

- 支持 npm 注册表格式，包括私有包功能、作用域支持、包访问控制和 Web 界面中的已认证用户。
- 提供钩子远程注册表的能力，并能将每个依赖路由到不同的注册表，并缓存 tarball。为了减少重复下载并在本地开发和 CI 服务器中节省带宽，你应该代理所有依赖。
- 默认情况下，作为认证提供者使用 htpasswd 安全性，但也支持 Gitlab、Bitbucket、LDAP。你还可以使用自己的认证方式。
- 易于使用不同的存储提供者进行扩展。
- 如果你的项目基于 Docker，使用官方镜像是最佳选择。
- 它能快速引导测试环境，并且对测试大型单一仓库项目很方便。

## 7) 负责任地披露安全漏洞

当发现安全漏洞时，如果在没有事先警告或为无法自我保护的用户提供适当补救措施的情况下公开，可能会构成潜在的严重威胁。

建议安全研究人员遵循负责任的披露计划，这是一套旨在将研究人员与易受攻击资产的供应商或维护者联系起来的流程和指南，以传达漏洞、其影响和适用性。一旦漏洞得到正确分类，供应商和研究人员会协调修复和漏洞公开日期，努力在安全问题公开之前为受影响的用户提供升级路径或补救措施。

## 8) 启用双因素认证

2017 年 10 月，npm 正式宣布为使用 npm 注册表托管其封闭和开源包的开发者提供双因素认证（2FA）支持。

尽管 npm 注册表对 2FA 的支持已经有一段时间了，但似乎采用进度缓慢。一个例子是 2018 年中期的 eslint-scope 事件，当 ESLint 团队的一个开发者账户被盗时，导致恶意行为者发布了 [eslint-scope 的恶意版本](https://snyk.io/vuln/npm:eslint-scope)。

启用 2FA 是 npm 安全最佳实践中简单而重要的一步。注册表支持两种启用用户账户 2FA 的模式：

- 仅授权模式 - 当用户通过网站或 CLI 登录 npm，或执行更改个人资料信息等操作时。
- 授权和写入模式 - 包括个人资料和登录操作，以及管理令牌和包、团队和包可见性信息等写入操作。

准备一个认证应用程序，如可以安装在移动设备上的 Google 身份验证器，你就可以开始了。通过 npm 的用户界面启用 2FA 扩展保护是最简单的方法。如果你是命令行用户，在使用支持的 npm 客户端版本（>=5.5.1）时也可以轻松启用 2FA：

```sh
npm profile enable-2fa auth-and-writes
```

按照命令行说明启用 2FA 并保存紧急认证码。如果你只想为登录和个人资料更改启用 2FA 模式，可以将上面代码中的 `auth-and-writes` 替换为 `auth-only`。

## 9) 使用 npm 作者令牌

每次使用 npm CLI 登录时，都会为你的用户生成一个令牌，并向 npm 注册表进行认证。令牌使得在 CI 和自动化程序中执行 npm 注册表相关操作变得容易，如访问注册表上的私有模块或从构建步骤发布新版本。

可以通过 npm 注册表网站以及 npm 命令行客户端管理令牌。以下是使用 CLI 创建仅限读取且限制在特定 IPv4 地址范围的令牌的示例：

```sh
npm token create --read-only --cidr=192.0.2.0/24
```

要验证为你的用户创建了哪些令牌，或在紧急情况下撤销令牌，可以分别使用 `npm token list` 或 `npm token revoke`。

确保遵循这个 npm 安全最佳实践，保护并最小化 npm 令牌的暴露。

## 10) 理解模块命名约定和拼写错误攻击

在创建包时，命名模块可能是你做的第一件事，但在定义最终名称之前，npm 定义了一些包名必须遵循的规则：

- 限制为 214 个字符
- 不能以点或下划线开头
- 名称中不能有大写字母
- 不能有尾随空格
- 只能使用小写字母
- 不允许某些特殊字符："~\'!()*")'
- 不能以 . 或 _ 开头
- 不能使用 node_modules 或 favicon.ico
- 即使遵循这些规则，也要注意 npm 在发布新包时使用基于分数和包名是否违反服务条款的垃圾检测机制。如果违反条件，注册表可能会拒绝请求。

拼写错误攻击是一种依赖用户错误（如打字错误）的攻击。通过拼写错误攻击，恶意行为者可以在 npm 注册表上发布恶意模块，其名称看起来非常类似于现有的流行模块。

我们一直在跟踪 npm 生态系统中的数十个恶意包；它们也出现在 PyPi Python 注册表上。也许一些最受关注的事件包括 [cross-env](https://snyk.io/vuln/npm:crossenv:20170802)、[event-stream](https://snyk.io/vuln/SNYK-JS-EVENTSTREAM-72638) 和 [eslint-scope](https://snyk.io/vuln/npm:eslint-scope:20180712)。

拼写错误攻击的主要目标之一是用户凭据，因为任何包都可以通过全局变量 process.env 访问环境变量。我们过去看到的其他例子包括 event-stream 事件，攻击者希望[将恶意代码注入](https://snyk.io/blog/a-post-mortem-of-the-malicious-event-stream-backdoor)应用程序的源代码。

为了减少此类攻击的风险，我们的十大 npm 安全最佳实践的结尾是以下建议：

- 在终端中复制粘贴包安装说明时要特别小心。确保在源代码仓库和 npm 注册表上验证这确实是你打算安装的包。你可以使用 `npm info` 验证包的元数据，以获取有关贡献者和最新版本的更多信息。
- 在日常工作中默认保持 npm 登出状态，这样你的凭据就不会成为容易被攻击的弱点。
- 安装包时，添加 `--ignore-scripts` 以降低任意命令执行的风险。例如：`npm install my-malicious-package --ignore-scripts`
