# 攻击面分析备忘录

## 什么是攻击面分析，为什么它很重要

本文描述了一种简单且务实的攻击面分析和管理应用程序攻击面的方法。它旨在帮助开发人员在设计和更改应用程序时理解和管理应用程序安全风险，同时也适用于进行安全风险评估的应用程序安全专家。本文重点关注保护应用程序免受外部攻击，不考虑针对系统用户或操作者的攻击（如恶意软件注入、社会工程攻击），对内部威胁的关注相对较少，尽管基本原则仍然相同。内部攻击面可能与外部攻击面不同，某些用户可能拥有大量访问权限。

攻击面分析是关于梳理系统中需要审查和测试安全漏洞的部分。攻击面分析的目的是：

1. 了解应用程序中的风险区域
2. 使开发人员和安全专家意识到应用程序中哪些部分容易受到攻击
3. 找到最小化这些风险的方法
4. 注意攻击面何时以及如何变化，并评估其风险影响

虽然攻击面分析通常由安全架构师和渗透测试人员执行，但开发人员在设计、构建和更改系统时也应该理解和监控攻击面。

攻击面分析可以帮助您：

1. 识别需要审查/测试安全漏洞的功能和系统部分
2. 识别需要深度防御保护的高风险代码区域
3. 识别攻击面的变化，并需要进行某种威胁评估

## 定义应用程序的攻击面

攻击面描述了攻击者可能进入系统和获取数据的所有不同点。

应用程序的攻击面包括：

1. 进入和离开应用程序的所有数据/命令路径
2. 保护这些路径的代码（包括资源连接、认证、授权、活动日志、数据验证和编码）
3. 应用程序中使用的所有有价值的数据，包括秘密和密钥、知识产权、关键业务数据、个人数据和个人可识别信息（PII）
4. 保护这些数据的代码（包括加密、校验和、访问审计以及数据完整性和操作安全控制）

将此模型与可以访问系统的不同类型用户（角色、权限级别）叠加。复杂性随着不同类型用户数量的增加而增加。重点关注两个极端：未经身份验证的匿名用户和高权限管理员用户（如数据库管理员、系统管理员）。

根据风险（面向外部或面向内部）、目的、实现、设计和技术，将每种攻击点分组到不同的类别中。然后，计算每种类型的攻击点数量。接下来，为每种类型选择一些案例。最后，将审查/评估重点放在这些案例上。

通过这种方法，您无需了解每个端点就能理解系统的攻击面和潜在风险配置。相反，您可以计算不同类型端点的数量。这使您能够预算大规模风险评估所需的成本，并且可以判断应用程序的风险状况何时发生重大变化。

### 微服务和云原生应用程序

微服务和云原生应用程序由多个较小的组件组成，使用 API 松散耦合并可独立扩展。在评估这种架构风格的应用程序的攻击面时，应优先考虑可从攻击源（例如来自互联网的外部流量）访问的组件。这些组件可能位于代理、负载均衡器和入口控制器的多个层后面，并且可能在未经警告的情况下自动扩展。

开源工具如 [Scope](https://github.com/weaveworks/scope) 或 [ThreatMapper](https://github.com/deepfence/ThreatMapper) 可帮助可视化攻击面。

## 识别和映射攻击面

您可以从图片和笔记开始构建攻击面的基准描述。花几个小时从攻击者的角度审查设计和架构文档。阅读源代码并识别不同的入口/出口点：

- 用户界面（UI）表单和字段
- HTTP 头和 Cookie
- API
- 文件
- 数据库
- 其他本地存储
- 电子邮件或其他类型的消息
- 运行时参数
- ...您的入口/出口点

不同攻击点的总数很容易达到数千个或更多。为了使其可管理，根据功能、设计和技术将模型划分为不同类型：

- 登录/身份验证入口点
- 管理界面
- 查询和搜索功能
- 数据输入（CRUD）表单
- 业务工作流
- 事务性接口/API
- 操作命令和监控接口/API
- 与其他应用程序/系统的接口
- ...您的类型

通过访谈开发人员和系统用户，并再次通过审查源代码，您还需要识别应用程序中有价值的数据（例如机密、敏感、受监管的数据）。

您还可以通过扫描应用程序来构建攻击面的图像。对于 Web 应用程序，您可以使用 [OWASP ZAP](https://www.zaproxy.org/)、[Arachni](http://arachni-scanner.com/)、[Skipfish](http://code.google.com/p/skipfish/) 或 [w3af](https://docs.w3af.org) 等工具，或众多商业动态测试和漏洞扫描工具或服务来爬取您的应用程序并映射可通过 Web 访问的应用程序部分。某些 Web 应用程序防火墙（WAF）也可能能够导出应用程序入口点的模型。

通过演练系统中的一些主要用例来验证和填充您对攻击面的理解：注册和创建用户配置文件、登录、搜索项目、下单、更改订单等。跟踪系统中的控制和数据流，查看信息如何验证和存储，触及哪些资源，涉及哪些其他系统。攻击面分析和[应用程序威胁建模](https://owasp.org/www-community/Application_Threat_Modeling)之间存在递归关系：攻击面的变化应触发威胁建模，而威胁建模有助于理解应用程序的攻击面。

攻击面模型一开始可能是粗糙且不完整的，尤其是在您之前没有对应用程序进行任何安全工作的情况下。随着您在安全分析中深入挖掘，或者随着您更多地使用应用程序并意识到对攻击面的理解已经改进，逐步填补空白。

## 测量和评估攻击面

一旦绘制出攻击面地图，就识别高风险区域。重点关注远程入口点 - 与外部系统和互联网的接口，尤其是系统允许匿名、公共访问的地方。

- 面向网络，尤其是面向互联网的代码
- Web 表单
- 来自网络外部的文件
- 与其他系统的向后兼容接口 - 旧协议、有时是旧代码和库，难以维护和测试多个版本
- 自定义 API - 协议等 - 可能在设计和实现中存在错误
- 安全代码：与加密、认证、授权（访问控制）和会话管理有关的任何内容

这些往往是您最容易受到攻击的地方。然后了解您已经部署的补偿性控制措施，如网络防火墙、应用程序防火墙，以及入侵检测或预防系统，以帮助保护您的应用程序。

微软的 Michael Howard 和其他研究人员开发了一种测量应用程序攻击面的方法，称为[相对攻击面商数（RSQ）](https://www.cs.cmu.edu/~wing/publications/Howard-Wing03.pdf)，用于跟踪攻击面随时间的变化。使用这种方法，您可以计算系统的整体攻击面得分，并在系统和部署方式发生变化时测量该得分。卡内基梅隆的研究人员在此基础上开发了一种正式的方法，为 SAP 等大型系统计算[攻击面指标](https://mlsec.info/pdf/tse11.pdf)。他们将攻击面计算为所有入口和出口点、通道（客户端或外部系统连接到系统的不同方式，包括 TCP/UDP 端口、RPC 端点、命名管道...）和不受信任的数据元素的总和。然后，他们对这些攻击面元素应用损害潜力/努力比率，以识别高风险区域。

请注意，部署多个应用程序版本，保留不再使用的功能以防将来可能需要，或保留旧备份副本和未使用的代码都会增加攻击面。应使用源代码控制和强大的变更管理/配置实践，确保实际部署的攻击面尽可能接近理论攻击面。

代码和数据的备份 - 在线和离线媒体 - 是系统攻击面的重要但常被忽视的部分。通过编写安全软件和加固基础设施来保护您的数据和知识产权，如果由于未保护备份而将所有内容交给不良行为者，这一切都将付之东流。

## 管理攻击面

一旦建立了对攻击面的基准理解，您可以在对应用程序进行更改时逐步识别和管理未来的风险。问问自己：

- 发生了什么变化？
- 您在做什么不同的事情？（技术、新方法等）
- 您可能打开了哪些漏洞？

您创建的第一个网页显著地打开了系统的攻击面，并引入了各种新风险。如果您在该页面添加另一个字段，或者添加类似的另一个网页，从技术上讲，您已经扩大了攻击面，但并未以有意义的方式增加应用程序的风险状况。除非您遵循新的设计或使用新框架，否则这些增量更改都是类似的。

如果您添加的新网页遵循现有网页的相同设计和技术，很容易理解它需要多少安全测试和审查。如果您添加新的 Web 服务 API 或可从互联网上传的文件，每个这样的更改都有不同的风险状况 - 查看更改是否符合现有类别，现有的控制和保护是否适用。如果您添加的内容不属于现有类别，这意味着您必须进行更彻底的风险评估，以了解可能打开哪些安全漏洞以及需要采取哪些保护措施。

对会话管理、认证和密码管理的更改直接影响攻击面，需要进行审查。对授权和访问控制逻辑的更改也是如此，尤其是添加或更改角色定义、添加具有高权限的管理员用户或管理员功能。同样适用于处理加密和秘密的代码更改。以及对数据验证方式的基本更改。对分层和信任关系的主要架构更改，或技术架构的基本更改 - 更换 Web 服务器或数据库平台，或更改运行时操作系统。

随着您添加新的用户类型、角色或权限级别，进行相同类型的分析和风险评估。将访问类型叠加到数据和功能上，查找问题和不一致之处。重要的是要理解应用程序的访问模型，是正向（默认拒绝访问）还是反向（默认允许访问）。在正向访问模型中，定义对新用户类型或角色的数据或功能权限时的任何错误都很容易发现。在反向访问模型中，您必须更加小心，确保用户不会获得不应被允许的数据/功能的访问权限。

这种威胁或风险评估可以定期进行，或作为串行/阶段/螺旋/瀑布开发项目的设计工作的一部分，或在敏捷/迭代开发中持续且增量地进行。

通常，随着添加更多接口、用户类型和与其他系统集成，应用程序的攻击面会随时间增加。您还希望寻找通过简化模型（例如减少用户级别数量）、关闭未使用的功能和接口来减小攻击面的方法，通过引入操作控制（如 Web 应用程序防火墙（WAF）和实时应用程序特定攻击检测）。
