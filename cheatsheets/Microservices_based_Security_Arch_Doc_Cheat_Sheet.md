# 微服务安全架构文档备忘录

## 引言

微服务架构正越来越多地被用于设计和实现云端和本地基础设施中的应用系统。在应用设计和实现阶段需要解决许多安全挑战。为了应对一些安全挑战，有必要收集应用架构的安全特定信息。

本文的目标是提供一种具体的方法，用于收集基于微服务的架构信息以保护应用。

## 背景

在保护基于微服务架构的应用时，安全架构师/工程师通常会面临以下问题（主要参考 [OWASP 应用安全验证标准项目](https://github.com/OWASP/ASVS)中的 [V1"架构、设计和威胁建模要求"](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)）：

1. 威胁建模和最小权限原则执行：
    - 微服务访问其他微服务 API 最少需要哪些作用域或 API 密钥？
    - 微服务访问数据库或消息队列最少需要哪些授权？
2. 数据泄露分析：
    - 哪些存储或消息队列包含敏感数据？
    - 微服务是否从/向特定数据库或消息队列读/写数据？
    - 哪些微服务被特定微服务调用？微服务之间传递了哪些数据？
3. 攻击面分析：
    - 在安全测试期间需要测试哪些微服务端点？

在大多数情况下，现有的应用架构文档不适合回答这些问题。以下部分提出了可以收集哪些安全特定的架构信息来回答上述问题。

## 目标

本备忘录的目标是解释可以收集哪些安全特定的架构信息以回答上述问题，并提供收集基于微服务的架构信息以保护应用的具体方法。

## 建议

### 收集构建块的信息

#### 识别和描述应用功能服务

应用功能服务实现一个或多个业务流程或功能（例如，存储客户详细信息、存储和显示产品目录）。收集与每个应用功能服务相关的以下参数的信息。

| 参数名称 | 描述 |
| :--- | :--- |
| 服务名称（ID） | 唯一的服务名称或 ID
| 简短描述 | 微服务实现的业务流程或功能的简短描述
| 源代码仓库链接 | 指定服务源代码仓库的链接
| 开发团队 | 指定开发该微服务的开发团队
| API 定义 | 如果微服务公开外部接口，请指定接口描述的链接（例如，OpenAPI 规范）。建议定义使用的安全方案，例如定义调用特定端点所需的作用域或 API 密钥（例如，[参见](https://swagger.io/docs/specification/authentication/)）
| 微服务架构描述 | 指定微服务架构图、描述的链接（如果可用）
| 运行手册链接 | 指定微服务运行手册的链接

#### 识别和描述基础设施服务

基础设施服务（包括远程服务）可以实现身份认证、授权、服务注册和发现、安全监控、日志记录等。收集与每个基础设施服务相关的以下参数的信息。

| 参数名称 | 描述 |
| :--- | :--- |
| 服务名称（ID） | 唯一的服务名称或 ID
| 简短描述 | 服务实现的功能的简短描述（例如，身份认证、授权、服务注册和发现、日志记录、安全监控、API 网关）
| 源代码仓库链接 | 指定服务源代码仓库的链接（如果适用）
| 服务文档链接 | 指定包含服务 API 定义、操作指南/运行手册等的服务文档链接

#### 识别和描述数据存储

收集与每个数据存储相关的以下参数的信息。

| 参数名称 | 描述 |
| :--- | :--- |
| 存储名称（ID） | 唯一的存储名称或 ID
| 软件类型 | 指定实现数据存储的软件（例如，PostgreSQL、Redis、Apache Cassandra）

#### 识别和描述消息队列

消息系统（例如，RabbitMQ 或 Apache Kafka）用于实现异步微服务通信机制。收集与每个消息队列相关的以下参数的信息。

| 参数名称 | 描述 |
| :--- | :--- |
| 消息队列（ID） | 唯一的消息队列名称或 ID
| 软件类型 | 指定实现消息队列的软件（例如，RabbitMQ、Apache Kafka）

#### 识别和描述数据资产

识别和描述系统微服务/服务处理的数据资产。建议首先识别从安全角度看有价值的资产（例如，"用户信息"、"支付"）。收集与每个资产相关的以下参数的信息。

| 参数名称 | 描述 |
| :--- | :--- |
| 资产名称（ID） | 唯一的资产名称或 ID
| 保护级别 | 指定资产保护级别（例如，个人可识别信息、机密）
| 附加信息 | 添加澄清信息

### 收集构建块之间的关系信息

#### 识别"服务到存储"关系

收集与每个"服务到存储"关系相关的以下参数的信息。

| 参数名称 | 描述 |
| :--- | :--- |
| 服务名称（ID） | 指定上面定义的服务名称（ID）
| 存储名称（ID） | 指定上面定义的存储名称（ID）
| 访问类型 | 指定访问类型，例如"读取"或"读/写"

#### 识别"服务到服务"同步通信

收集与每个"服务到服务"同步通信相关的以下参数的信息。

| 参数名称 | 描述 |
| :--- | :--- |
| 调用方服务名称（ID） | 指定上面定义的调用方服务名称（ID）
| 被调用服务名称（ID） | 指定上面定义的被调用服务名称（ID）
| 使用的协议/框架 | 指定用于通信的协议/框架，例如 HTTP（REST、SOAP）、Apache Thrift、gRPC
| 简短描述 | 简要描述通信的目的（查询信息的请求或用于改变状态的业务功能的请求/命令）以及服务之间传递的数据（如果可能，使用上面定义的资产术语）

#### 识别"服务到服务"异步通信

收集与每个"服务到服务"异步通信相关的以下参数的信息。

| 参数名称 | 描述 |
| :--- | :--- |
| 发布方服务名称（ID） | 指定上面定义的发布方服务名称（ID）
| 订阅方服务名称（ID） | 指定上面定义的订阅方服务名称（ID）
| 消息队列（ID） | 指定上面定义的消息队列（ID）
| 简短描述 | 简要描述通信的目的（接收信息或用于改变状态的业务功能的命令）以及服务之间传递的数据（如果可能，使用上面定义的资产术语）

#### 识别"资产到存储"关系

收集与每个"资产到存储"关系相关的以下参数的信息。

| 参数名称 | 描述 |
| :--- | :--- |
| 资产名称（ID） | 上面定义的资产名称（ID）
| 存储名称（ID） | 指定上面定义的存储名称（ID）
| 存储类型 | 指定资产的存储类型，例如"黄金源"或"缓存"

### 创建应用架构的图形化表示

建议以服务调用图或数据流图的形式创建应用架构（上面定义的构建块和关系）的图形化表示。为此，可以使用专门的软件工具（例如 Enterprise Architect）或 [DOT 语言](https://en.wikipedia.org/wiki/DOT_%28graph_description_language%29)。请参见使用 DOT 语言的示例[此处](https://gist.github.com/vladgolubev/80c5523336ddec3859c0e90d9a070882)。

### 在安全软件开发实践中使用收集的信息

收集的信息可用于进行应用安全实践，例如在定义安全需求、威胁建模或安全测试期间。以下部分包含与保护应用架构相关的活动示例（以及与 OWASP 项目的映射），以及使用上述收集的信息实施这些活动的技巧。

#### 攻击面分析

##### 实施技巧

要枚举安全测试期间需要测试的微服务端点并在威胁建模期间进行分析，请分析以下部分收集的数据：

- 识别和描述应用功能服务（参数"API 定义"）
- 识别和描述基础设施服务（参数"服务文档链接"）

##### 映射到 OWASP 项目

- [OWASP ASVS, V1"架构、设计和威胁建模要求", #1.1.2](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)
- [OWASP 攻击面分析备忘录](https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Attack_Surface_Analysis_Cheat_Sheet.md)

#### 数据泄露分析

##### 实施技巧

要分析可能的数据泄露，请分析以下部分收集的数据：

- 识别和描述数据资产
- 识别"服务到存储"关系
- 识别"服务到服务"同步通信
- 识别"服务到服务"异步通信
- 识别"资产到存储"关系

##### 映射到 OWASP 项目

- [OWASP ASVS, V1"架构、设计和威胁建模要求", #1.1.2](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)
- [OWASP Top 10-2017 A3-敏感数据暴露](https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A3-Sensitive_Data_Exposure)

#### 应用的信任边界、组件和重要数据流的合理性

##### 实施技巧

要验证应用的所有信任边界、组件和重要数据流的文档和合理性，请分析以下部分收集的数据：

- 识别和描述应用功能服务
- 识别和描述基础设施服务
- 识别和描述数据存储
- 识别和描述消息队列
- 识别"服务到存储"关系
- 识别"服务到服务"同步通信
- 识别"服务到服务"异步通信

##### 映射到 OWASP 项目

- [OWASP ASVS, V1"架构、设计和威胁建模要求", #1.1.4](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### 应用高级架构分析

##### 实施技巧

要验证应用的高级架构定义和安全分析以及所有连接的远程服务，请分析以下部分收集的数据：

- 识别和描述应用功能服务
- 识别和描述基础设施服务
- 识别和描述数据存储
- 识别和描述消息队列

##### 映射到 OWASP 项目

- [OWASP ASVS, V1"架构、设计和威胁建模要求", #1.1.5](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### 集中式安全控制实施验证

##### 实施技巧

要验证实施集中的、简单的（设计经济性）、经过审查的、安全的和可重用的安全控制，以避免重复、缺失、无效或不安全的控制，请分析"识别和描述基础设施服务"部分收集的数据。

##### 映射到 OWASP 项目

- [OWASP ASVS, V1"架构、设计和威胁建模要求", #1.1.6](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### 最小权限原则的执行

##### 实施技巧

要定义微服务所需的最小权限，请分析以下部分收集的数据：

- 识别和描述应用功能服务（参数"API 定义"）
- 识别"服务到存储"关系
- 识别"服务到服务"同步通信
- 识别"服务到服务"异步通信

##### 映射到 OWASP 项目

- [OWASP ASVS, V1"架构、设计和威胁建模要求", #1.4.3](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### 敏感数据识别和分类

##### 实施技巧

要验证所有敏感数据已被识别并分类为保护级别，请分析以下部分收集的数据：

- 识别和描述数据资产
- 识别"资产到存储"关系

##### 映射到 OWASP 项目

- [OWASP ASVS, V1"架构、设计和威胁建模要求", #1.8.1](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)

#### 应用组件业务/安全功能验证

##### 实施技巧

要验证所有应用组件在其提供的业务或安全功能方面的定义和文档，请分析以下部分收集的数据（参数"简短描述"）：

- 识别和描述应用功能服务
- 识别和描述基础设施服务

##### 映射到 OWASP 项目

- [OWASP ASVS, V1"架构、设计和威胁建模要求", #1.11.1](https://github.com/OWASP/ASVS/blob/master/4.0/en/0x10-V1-Architecture.md#v1-architecture-design-and-threat-modeling-requirements)
