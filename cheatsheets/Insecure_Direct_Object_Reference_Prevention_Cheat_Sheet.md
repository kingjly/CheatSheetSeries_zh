# 不安全直接对象引用（IDOR）防护备忘录

## 引言

不安全直接对象引用（Insecure Direct Object Reference，简称 IDOR）是一种漏洞，当攻击者可以通过操纵 Web 应用程序 URL 或参数中的标识符来访问或修改对象时，就会出现这种漏洞。这是由于缺少访问控制检查，未能验证用户是否应被允许访问特定数据。

## 示例

例如，当用户访问自己的个人资料时，应用程序可能会生成如下 URL：

```
https://example.org/users/123
```

URL 中的 123 是对数据库中用户记录的直接引用，通常由主键表示。如果攻击者将此数字更改为 124 并成功访问另一个用户的信息，则应用程序存在不安全直接对象引用漏洞。这是因为应用程序在显示数据之前没有正确检查用户是否有权查看用户 124 的数据。

在某些情况下，标识符可能不在 URL 中，而是在 POST 请求体中，如下例所示：

```
<form action="/update_profile" method="post">
  <!-- 用于更新姓名、电子邮件等的其他字段 -->
  <input type="hidden" name="user_id" value="12345">
  <button type="submit">更新个人资料</button>
</form>
```

在此示例中，应用程序允许用户通过提交包含用户 ID 的隐藏字段的表单来更新其个人资料。如果应用程序没有在服务器端执行适当的访问控制，攻击者可以操纵"user_id"字段，未经授权修改其他用户的个人资料。

## 标识符复杂性

在某些情况下，使用更复杂的标识符（如 GUID）可以使攻击者实际上无法猜测有效值。然而，即使使用复杂的标识符，访问控制检查仍然至关重要。如果攻击者获得未经授权对象的 URL，应用程序仍应阻止其访问尝试。

## 缓解措施

为缓解 IDOR，请为用户尝试访问的每个对象实施访问控制检查。Web 框架通常提供便于实现这一点的方法。另外，使用复杂的标识符作为深度防御措施，但请记住，即使使用这些标识符，访问控制也至关重要。

尽可能避免在 URL 和 POST 请求体中暴露标识符。相反，从会话信息中确定当前已认证的用户。在使用多步骤流程时，在会话中传递标识符以防止篡改。

在根据主键查找对象时，使用用户有权访问的数据集。例如，在 Ruby on Rails 中：

```ruby
// 存在漏洞，搜索所有项目
@project = Project.find(params[:id])
// 安全，搜索与当前用户相关的项目
@project = @current_user.projects.find(params[:id])
```

每次尝试访问时都验证用户的权限。使用 Web 框架推荐的方法结构化地实现此功能。

作为深度防御的额外措施，将可枚举的数字标识符替换为更复杂、随机的标识符。可以通过在数据库表中添加随机字符串列，并在 URL 中使用这些字符串而不是数字主键来实现。另一种选择是使用 UUID 或其他长随机值作为主键。避免加密标识符，因为安全地这样做可能很具挑战性。
