# 多因素认证备忘录

## 引言

多因素认证（MFA）或双因素认证（2FA）是指用户需要提供多种类型的证据才能在系统上进行身份验证。存在五种不同类型的证据（或因素），可以使用任意组合，但在实践中，Web 应用程序通常只使用前三种。这五种类型如下：

| 因素 | 示例 |
|--------|----------|
| [你知道的](#你知道的) | [密码和 PIN](#密码和-pin)，[安全问题](#安全问题) |
| [你拥有的](#你拥有的) | [一次性密码令牌](#一次性密码令牌)，[U2F 令牌](#通用第二因素)，[证书](#证书)，[智能卡](#智能卡)，[电子邮件](#电子邮件)，[短信和电话](#短信消息和电话) |
| [你是什么](#你是什么) | [指纹、面部识别、虹膜扫描](#生物特征) |
| [你在哪里](#你在哪里) | [源 IP 地址](#源-ip-地址)，[地理位置](#地理位置)，[地理围栏](#地理围栏) |
| [你做什么](#你做什么) | [行为分析](#行为分析)，[键盘和鼠标动态](#键盘和鼠标动态)，[步态分析](#步态分析) |

需要注意的是，要求同一认证因素的多个实例（如同时需要密码和 PIN）**不构成 MFA**，并且提供的额外安全性很小。使用的因素应相互独立，不应能被同一攻击方式破坏。尽管以下章节讨论了各种 MFA 类型的缺点和弱点，但在许多情况下，这些只与针对性攻击相关。**任何 MFA 都比没有 MFA 好**。

## 优势

用户账户被入侵最常见的方式是使用弱密码、重复使用密码或密码被盗。尽管应用程序上实施了技术安全控制，但用户仍可能选择弱密码，或在不同应用程序上使用相同密码。作为开发者或系统管理员，应该假设用户的密码将在某个时候被泄露，并相应地设计系统。

MFA 是防范大多数与密码相关的攻击（包括暴力破解、[凭证填充](Credential_Stuffing_Prevention_Cheat_Sheet.md)和密码喷洒）的最佳防御手段，微软的分析表明，它可以阻止 [99.9% 的账户入侵](https://techcommunity.microsoft.com/t5/Azure-Active-Directory-Identity/Your-Pa-word-doesn-t-matter/ba-p/731984)。

## 缺点

MFA 最大的缺点是增加了管理复杂性，无论对管理员还是最终用户都是如此。许多技术水平较低的用户可能会发现配置和使用 MFA 很困难。此外，还存在一些常见问题：

- 需要用户拥有特定硬件的 MFA 类型可能会引入显著的成本和管理开销。
- 如果用户丢失或无法使用其他因素，可能会被锁定在账户之外。
- MFA 为应用程序增加了额外的复杂性。
- 许多 MFA 解决方案为系统增加了外部依赖，可能引入安全漏洞或单点故障。
- 允许用户绕过或重置 MFA 的流程可能被攻击者利用。
- 要求 MFA 可能会阻止某些用户访问应用程序。

## 快速建议

在应用程序中具体何时以及如何实施 MFA 将取决于多个因素，包括应用程序的威胁模型、用户的技术水平以及对用户的管理控制水平。这些需要针对每个应用程序进行考虑。

然而，以下建议通常适用于大多数应用程序，并提供了一个初步的考虑起点：

- 为所有用户要求某种形式的 MFA。
- 提供选项让用户使用 [TOTP](#软件-otp-令牌) 在其账户上启用 MFA。
- 对管理员或其他高权限用户要求 MFA。
- 实施安全程序以允许用户重置其 MFA。
- 考虑[使用第三方服务](#考虑使用第三方服务)。

## 实施 MFA

MFA 是一个关键的安全控制，建议在所有应用程序中使用。以下章节提供了如何实施 MFA 的指导，以及应考虑的因素。

### 法规和合规要求

许多行业和国家都有要求使用 MFA 的法规。这在金融和医疗保健行业尤为常见，并且通常需要遵守欧盟的通用数据保护条例（GDPR）。在实施 MFA 时，考虑这些要求很重要。

### 何时要求 MFA

在应用程序中要求 MFA 最重要的地方是用户登录时。然而，根据可用功能，对于执行敏感操作，可能也适合要求 MFA，例如：

- 更改密码或安全问题。
- 更改与账户关联的电子邮件地址。
- 禁用 MFA。
- 将用户会话提升为管理员会话。

如果应用程序为用户提供多种认证方式，这些方式都应要求 MFA，或实施其他保护措施。一个常被忽视的常见区域是应用程序是否提供可用于登录的单独 API，或有关联的移动应用程序。

### 改善用户体验

#### 基于风险的认证

频繁使用 MFA 登录会给用户带来额外负担，并可能导致用户在应用程序上禁用 MFA。基于风险的认证可用于减少 MFA 提示的频率，仅在用户执行被认为高风险的操作时才要求 MFA。一些示例包括：

- 当用户从新设备或新位置登录时要求 MFA。
- 当用户从被认为高风险的位置登录时要求 MFA。
- 允许企业 IP 范围（或使用[地理位置](#地理位置)作为额外因素）。

#### 通行密钥

基于 FIDO2 标准的[通行密钥](https://passkeys.dev/)是一种新的 MFA 形式，结合了[基于拥有](#你拥有的)和[基于知识](#你知道的)或[基于固有](#你是什么)认证的特征。用户需要拥有物理设备（如手机）并输入 [PIN](#密码和-pin) 或使用[生物识别认证](#生物特征)进行认证。用户的设备随后生成用于与服务器认证的加密密钥。这是一种非常安全的 MFA 形式，能抵御钓鱼攻击，同时对用户来说又相当流畅。

### 登录失败尝试

当用户输入密码但未能使用第二因素进行认证时，可能意味着以下两种情况之一：

- 用户已丢失其第二因素，或无法使用（例如，他们没有手机，或没有信号）。
- 用户的密码已被泄露。

发生这种情况时，应采取以下步骤：

- 提示用户尝试另一种 MFA 形式。
- 允许用户尝试[重置其 MFA](#重置-mfa)。
- 通知用户登录尝试失败，并鼓励他们在不认识该登录时更改密码。
    - 通知应包括登录尝试的时间、浏览器和地理位置。
    - 这应在他们下次登录时显示，并可选择通过电子邮件发送。

### 重置 MFA

实施 MFA 最大的挑战之一是处理用户遗忘或丢失额外因素的情况。可能发生的情况包括：

- 重新安装工作站时未备份数字证书。
- 擦除或丢失手机且未备份 OTP 码。
- 更换手机号码。

为防止用户被锁在应用程序之外，需要提供一种机制让他们在无法使用现有 MFA 的情况下重新获得账户访问权；但同时也至关重要的是，这不能为攻击者提供绕过 MFA 劫持账户的方法。

对此没有绝对的"最佳方法"，适当的方法将极大地取决于应用程序的安全性以及对用户的控制水平。适用于所有员工相互认识的企业应用程序的解决方案，对于全球拥有数千用户的公开可用应用程序来说可能是不可行的。每种恢复方法都有其优缺点，需要在应用程序的背景下进行评估。

一些可能的方法建议包括：

- 在用户首次设置 MFA 时提供若干一次性恢复码。
- 要求用户设置多种 MFA 类型（如数字证书、OTP 核心和短信电话号码），以使他们不太可能同时失去所有访问权限。
- 将一次性恢复码（或新的硬件令牌）邮寄到用户注册的地址。
- 要求用户联系支持团队，并建立严格的身份验证流程。
- 要求另一个可信用户为其担保。

### 考虑使用第三方服务

有许多第三方服务提供 MFA 即服务。对于没有资源自行实施 MFA 的应用程序，或需要对其 MFA 提供高水平保证的应用程序来说，这些可能是一个不错的选择。然而，重要的是要考虑第三方服务的安全性以及使用它的影响。例如，如果第三方服务被攻破，可能允许攻击者绕过使用该服务的所有应用程序的 MFA。

## 你知道的

基于知识的认证是最常见的认证类型，基于用户知道的内容 - 通常是密码。这种因素的最大优势是对开发者和最终用户都有很低的要求，因为它不需要任何特殊硬件，也不需要与其他服务集成。

### 密码和 PIN

由于实施简单，密码和 PIN 是最常见的认证形式。[认证备忘录](Authentication_Cheat_Sheet.md#implement-proper-password-strength-controls)提供了如何实施强密码策略的指导，[密码存储备忘录](Password_Storage_Cheat_Sheet.md)则提供了如何安全存储密码的指导。大多数多因素认证系统使用密码，以及至少一个其他因素。

#### 优点

- 简单且易于理解。
- 在每个认证框架中都有原生支持。
- 易于实施。

#### 缺点

- 用户倾向于选择弱密码。
- 密码在不同系统间常被重复使用。
- 容易受到钓鱼攻击。

### 安全问题

根据 [NIST SP 800-63](https://pages.nist.gov/800-63-3/sp800-63b.html)，**安全问题不再被认为是可接受的认证因素**。账户恢复只是另一种认证方式，因此不应比常规认证更弱。

#### 优点

- 没有不同于密码的优点。

#### 缺点

- 不再被认为是可接受的认证因素。
- 问题的答案通常很容易猜测。
- 问题的答案通常可以从社交媒体或其他来源获得。
- 必须仔细选择问题，以便用户能在多年后记住答案。
- 容易受到钓鱼攻击。

## 你拥有的

基于拥有的认证是基于用户拥有认证所需的物理或数字项目。这是最常见的 MFA 形式，通常与密码一起使用。基于拥有的认证最常见的类型是硬件和软件令牌，以及数字证书。如果正确实施，这对远程攻击者来说可能更难破坏；然而，它也给用户带来了额外的管理负担，因为他们必须在每次希望使用时随身携带认证因素。

### 一次性密码令牌

一次性密码（OTP）令牌是一种基于拥有的认证形式，用户需要提交不断变化的数字码进行认证。其中最常见的是基于时间的一次性密码（TOTP）令牌，可以是硬件或软件形式。

### 硬件 OTP 令牌

硬件 OTP 令牌生成不断变化的数字码，在认证时必须提交。最著名的是 [RSA SecureID](https://en.wikipedia.org/wiki/RSA_SecurID)，它生成每 60 秒变化一次的六位数字。

#### 优点

- 由于令牌是独立的物理设备，几乎不可能被远程攻击者破坏。
- 无需用户拥有手机或其他设备即可使用令牌。

#### 缺点

- 向用户部署物理令牌成本高昂且复杂。
- 如果用户丢失令牌，购买和运送新令牌可能需要相当长的时间。
- 某些实施需要后端服务器，可能引入新的漏洞和单点故障。
- 被盗令牌可以在没有 PIN 或设备解锁码的情况下使用。
- 容易受到钓鱼攻击（尽管生命周期短）。

### 软件 OTP 令牌

使用软件生成基于时间的一次性密码（TOTP）码是硬件令牌的一种更便宜、更简单的替代方案。这通常涉及用户在手机上安装 TOTP 应用程序，然后扫描 Web 应用程序提供的二维码以获取初始种子。认证器应用程序随后每 60 秒生成一个六位数字，与硬件令牌的工作方式非常相似。

大多数网站使用标准化的 TOTP 令牌，允许用户安装任何支持 TOTP 的认证器应用程序。然而，少数应用程序使用自己的变体（如 Symantec），这要求用户安装特定应用程序才能使用服务。应避免这种做法，转而采用基于标准的方法。

#### 优点

- 没有物理令牌大大降低了系统实施的成本和管理开销。
- 当用户无法访问 TOTP 应用程序时，可以配置新的应用程序，无需运送物理令牌。
- TOTP 被广泛使用，许多用户已经安装了至少一个 TOTP 应用程序。
- 只要用户的手机有屏幕锁，攻击者即使偷走手机也无法使用码。

#### 缺点

- TOTP 应用程序通常安装在移动设备上，容易受到破坏。
- TOTP 应用程序可能安装在用于认证的同一移动设备（或工作站）上。
- 用户可能不安全地存储备份种子。
- 并非所有用户都有可用于 TOTP 的移动设备。
- 如果用户的移动设备丢失、被盗或电池耗尽，他们将无法认证。
- 容易受到钓鱼攻击（尽管生命周期短）。

### 通用第二因素

#### 硬件 U2F 令牌

通用第二因素（U2F）是一种 USB/NFC 硬件令牌的标准，它实现基于挑战-响应的认证，而不是要求用户手动输入码。这通常是通过用户按下令牌上的按钮，或将其靠近 NFC 读取器来完成的。最常见的 U2F 令牌是 [YubiKey](https://www.yubico.com/products/yubikey-hardware/)。

#### 优点

- U2F 令牌对钓鱼具有抵抗力，因为私钥永远不会离开令牌。
- 用户只需按下按钮，而不是输入码。
- 由于令牌是独立的物理设备，几乎不可能被远程攻击者破坏。
- 主要 Web 浏览器原生支持 U2F。
- U2F 令牌可以使用，无需用户拥有手机或其他设备。

#### 缺点

- 与硬件 OTP 令牌一样，使用物理令牌会引入显著的成本和管理开销。
- 被盗令牌可以在没有 PIN 或设备解锁码的情况下使用。
- 由于令牌通常通过 USB 连接到工作站，用户更容易忘记它们。

### 证书

数字证书是存储在用户设备上的文件，在认证时自动与用户密码一起提供。最常见的类型是 X.509 证书，更常被称为[客户端证书](Transport_Layer_Security_Cheat_Sheet.md#client-certificates-and-mutual-tls)。所有主要 Web 浏览器都支持证书，一旦安装，就不需要用户进一步交互。证书应链接到个人用户账户，以防止用户尝试对其他账户进行认证。

#### 优点

- 无需购买和管理硬件令牌。
- 安装后，证书对用户来说非常简单。
- 证书可以集中管理和撤销。
- 对钓鱼具有抵抗力。

#### 缺点

- 使用数字证书需要后端公钥基础设施（PKI）。
- 对于用户来说，特别是在高度受限的环境中，安装证书可能很困难。
- 执行 SSL 解密的企业代理服务器将阻止使用证书。
- 证书存储在用户的工作站上，因此如果系统被入侵，可能会被盗。

### 智能卡

智能卡是信用卡大小的卡片，其芯片包含用户的数字证书，通过 PIN 解锁。它们通常用于操作系统认证，但在 Web 应用程序中很少使用。

#### 优点

- 没有 PIN 不能使用被盗的智能卡。
- 智能卡可以跨多个应用程序和系统使用。
- 对钓鱼具有抵抗力。

#### 缺点

- 管理和分发智能卡的成本和开销与硬件令牌相同。
- 现代浏览器不原生支持智能卡，需要第三方软件。
- 尽管大多数商务级笔记本电脑内置智能卡读卡器，但家用系统通常没有。
- 使用智能卡需要后端 PKI。

### 短信消息和电话

可以使用短信或电话向用户提供单次使用的码，作为额外因素提交。由于这些方法存在风险，不应用于保护包含个人可识别信息（PII）或存在财务风险的应用程序，如医疗保健和银行。[NIST SP 800-63](https://pages.nist.gov/800-63-3/sp800-63b.html) 不允许在包含 PII 的应用程序中使用这些因素。

#### 优点

- 相对简单实施。
- 要求用户将其账户链接到手机号码。

#### 缺点

- 要求用户拥有移动设备或固定电话。
- 需要用户有信号或互联网接入以接收呼叫或消息。
- 呼叫和短信发送可能需要付费，需要防止攻击者请求大量消息以耗尽资金。
- 容易受到 SIM 卡交换攻击。
- 短信可能在用户认证的同一设备上接收。
- 容易受到钓鱼攻击。
- 短信可能在设备锁定时预览。
- 短信可能被恶意或不安全的应用程序读取。

### 电子邮件

电子邮件验证要求用户输入发送到其电子邮件地址的码或点击链接。关于电子邮件是否构成 MFA 的形式存在一些争议，因为如果用户没有在其电子邮件账户上配置 MFA，它仅仅需要知道用户的电子邮件密码（通常与其应用程序密码相同）。但是，为了完整性，这里仍然包含了它。

#### 优点

- 非常容易实施。
- 不需要单独的硬件或移动设备。

#### 缺点

- 完全依赖于电子邮件账户的安全性，而电子邮件账户通常缺乏 MFA。
- 电子邮件密码通常与应用程序密码相同。
- 如果用户的电子邮件首先被入侵，则无法提供保护。
- 电子邮件可能在用户认证的同一设备上接收。
- 容易受到钓鱼攻击。

## 你是什么

基于固有的认证基于用户的物理属性。这在 Web 应用程序中不太常见，因为它要求用户拥有特定硬件，并且在隐私方面通常被认为是最具侵入性的。然而，它在操作系统认证中很常见，在某些移动应用程序中也有使用。

### 生物特征

使用的常见生物特征类型包括：

- 指纹扫描
- 面部识别
- 虹膜扫描
- 语音识别

#### 优点

- 实施良好的生物特征很难被欺骗，需要有针对性的攻击。
- 对用户来说快速且方便。

#### 缺点

- 需要用户手动注册。
- 通常需要定制（有时昂贵）的硬件来读取生物特征。
- 隐私问题：必须存储关于用户的敏感物理信息。
- 如果被入侵，生物特征数据很难更改。
- 硬件可能容易受到额外的攻击向量。

## 你在哪里

基于位置的认证基于用户的物理位置。有时有人争论位置是在决定是否需要 MFA 时使用的（如[上文](#何时要求-mfa)所讨论），但这实际上与将其视为独立因素没有实质性区别。两个突出的例子是 Microsoft Azure 中可用的[条件访问策略](https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/overview)和 BitLocker 中的[网络解锁](https://docs.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-how-to-enable-network-unlock)功能。

### 源 IP 地址

用户连接的源 IP 地址可以作为一个因素使用，通常采用允许列表方法。这可以基于静态列表（如企业办公室范围）或动态列表（如用户之前认证的 IP 地址）。

#### 优点

- 对用户非常容易。
- 需要管理人员进行最少的配置和管理。

#### 缺点

- 如果用户系统被入侵，无法提供任何保护。
- 无法防范内部恶意用户。
- 必须仔细限制受信任的 IP 地址（例如，如果开放的访客 Wi-Fi 使用主要企业 IP 范围）。

### 地理位置

与使用用户的确切 IP 地址不同，可以使用 IP 地址注册的地理位置。这不太精确，但在 IP 地址不静态的环境中可能更可行。常见用法是当认证尝试来自用户正常国家/地区之外时，要求额外的认证因素。

#### 优点

- 对用户非常容易。

#### 缺点

- 如果用户系统被入侵，无法提供任何保护。
- 无法防范内部恶意用户。
- 攻击者可以通过获取受信任国家/地区的 IP 地址轻松绕过。
- Apple 的 [iCloud 私有中继](https://support.apple.com/en-us/102602)等隐私功能和 VPN 可能会降低准确性。

### 地理围栏

地理围栏是地理位置的更精确版本，允许用户定义他们被允许认证的特定区域。这在移动应用程序中经常使用，用户的位置可以使用 GPS 等地理定位硬件高精度地确定。

#### 优点

- 对用户非常容易。
- 对远程攻击者提供高级别保护。

#### 缺点

- 如果用户系统被入侵，无法提供任何保护。
- 无法防范内部恶意用户。
- 无法防范靠近受信任位置的攻击者。

## 你做什么

基于行为的认证基于用户的行为，如打字方式、鼠标移动或使用移动设备的方式。这是最不常见的 MFA 形式，通常与其他因素结合以提高对用户身份的保证水平。这也是最难实施的，可能需要特定硬件以及大量数据和处理能力来分析用户行为。

### 行为分析

行为分析基于用户与应用程序交互的方式，如登录时间、使用的设备以及浏览应用程序的方式。这在与[基于风险的认证](#基于风险的认证)和[用户与实体行为分析](https://learn.microsoft.com/en-us/azure/sentinel/identify-threats-with-entity-behavior-analytics)（UEBA）系统结合使用时，正迅速在 Web 应用程序中变得更加常见。

#### 优点

- 不需要用户交互。
- 可用于持续认证用户。
- 与其他因素结合良好，可提高对用户身份的保证水平。

#### 缺点

- 早期的行为分析实施常常不准确，导致大量误报。
- 需要大量数据和处理能力来分析用户行为。
- 在用户行为可能频繁变化的环境中可能难以实施。

### 键盘和鼠标动态

键盘和鼠标动态基于用户打字和移动鼠标的方式。例如，按键之间的时间、按键按下和释放之间的时间，以及鼠标的速度和加速度。这在很大程度上是理论性的，在实践中并未广泛使用。

#### 优点

- 无需额外硬件即可使用。
- 无需用户额外交互。
- 可用于持续认证用户。
- 可用于检测系统使用者是否为用户。
- 可用于检测用户是否在受到胁迫。
- 可用于检测用户是否处于不适合使用系统的状态。

#### 缺点

- 不太可能准确到可以作为独立因素使用。
- 可能被 AI 或其他高级攻击欺骗。

### 步态分析

步态分析基于使用摄像机和传感器分析用户走路的方式。它们常用于物理安全系统，但在 Web 应用程序中并不广泛使用。移动设备应用程序可能能够使用加速度计检测用户的步态并将其作为额外因素，但这仍然主要是理论性的。

#### 优点

- 非常难以欺骗。
- 可能无需用户额外交互即可使用。

#### 缺点

- 需要特定硬件实施。
- 在物理安全系统之外的使用尚未广泛测试。

## 参考文献和进一步阅读

- [NIST SP 800-63](https://pages.nist.gov/800-63-3/sp800-63b.html)
- [你的密码并不重要](https://techcommunity.microsoft.com/t5/Azure-Active-Directory-Identity/Your-Pa-word-doesn-t-matter/ba-p/731984)
- [FIDO2](https://fidoalliance.org/fido2/)
- [ENISA 个人数据处理安全手册](https://www.enisa.europa.eu/publications/handbook-on-security-of-personal-data-processing/@@download/fullReport)
- [Google Cloud 添加 MFA](https://cloud.google.com/identity-platform/docs/web/mfa)
